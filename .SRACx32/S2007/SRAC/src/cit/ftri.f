CFTRI 110.1  ***CITATION*** TRI. GEOM. LINE RELAX. 2-D/ CF-DNSD
C
      SUBROUTINE FTRI( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,
     & JVXP1,IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ)
C
CDEL  INTEGER RGX , MSX , ZNEX , ZDX , WZX
CDEL  PARAMETER ( RGX=100, MSX=211, ZDX=200, ZNEX=1000, WZX=100 )
      INCLUDE  'CITPMINC'
C
      REAL*8 P2
      REAL*8 BET(MSX),DEL(MSX),T,TEMP,TMF
      REAL*8 SCAT
C
      COMMON/ALSUB/BLSUB(30),TITL1(18),TITL2(18),IMAX,JMAX,KBMAX,KMAX,
     & LMAX,MMAX, NMAX,IMXP1,JMXP1,KBMXP1,NSETMX,NTO,MM1VX,KM1VX,IOIN,
     & IOUT,IOSIG,IOFLX,IO1,IO2,IO3,IO4,IO7,NER(100), IX(200),INNO(100),
     &  NGC(24),IEDG(24),ITMX(24),TIMX(6), GLIM(6),NDPL(24),IEDP1(24),
     & IEDP2(24),IEDP3(24), DPLH(6),NUAC(24),EPI(6),XMIS(6),NSRH(24),
     & XSRH1(6), XTR1(WZX),XTR2(WZX),NXTR1(WZX),NXTR2(WZX),SPARE(200),
     & IXPUT(200),XPUT(200)
      COMMON/AFLUX/BFLUX(30),KXMN8,NIT,NIIT,NIIIT,JXP1,KSCT1,KSCT2,
     & ISTART,IEP, VRGP1,VRGP2,VRGP3,VRG1,VRG2,VRGK1,VRGK2,XABS,PROD,
     & XLEK,RMX,RMN,XKEF1,XKEF2,XKEF3,EXFC1,EXFC2,EXFC3, NI3,IEXTR,
     & IRECV,VRGABS,LO3,LO4,XLAMDA,EPI1,EPI2, BETTA,SUMXI,IX25,IX28,I,J,
     &  KB,K,ITMAX,ITIME, BAT(MSX),DAL(MSX)
C
      DIMENSION SCAT(JVX,IVX), P2(JVX,IVX,KVX),DCONB(JVX,IVXP1,IOVX),
     & DCONR(JVXP1,IVZ,IOVZ),PTSA(JVX,IVX,IOVX)
      DIMENSION NRGN(JVX,IVX),E1(LVX,KVX)
C
      INRB=IX(72)+1
      N = IX(20)
CKSK
      IF (P2(1,1,K).NE.0.0) THEN
CBUG    TEMPW = 1/(PTSA(1,1,N)+E1(1,K))
        L = NRGN(1,1)
        TEMPW = 1/(PTSA(1,1,N)+E1(L,K))
      ENDIF
CKSK  
  100 DO 143 I = 1,IVX
      IP1 = I-1
      IP2 = I+1
      DEL(1) = 0.0
      D1 = DCONB(1,I,N)
      D4 = DCONR(2,I,N)
  101 IF (I-1) 102,102,108
  102 IF (P2(1,1,K)) 103,104,103
  103 BET(1) = SCAT(1,1)/D4
CKSK  DEL(1) = D4/(PTSA(1,1,N)+E1(1,K))
      DEL(1) = D4*TEMPW
      IF (INRB.EQ.2) BET(1) = BET(1)+P2(JVX,I,K)*DCONR(1,I,N)/D4
  104 DO 107 J = 2,JVX
      IF (P2(J,1,K)) 106,105,106
  105 DEL(J) = 0.0
      GO TO 107
  106 T=D4*DEL(J-1)
      L = NRGN(J,1)
      D4 = DCONR(J+1,1,N)
      TEMP = P2(J-1,2,K)*DCONB(J-1,2,N)
      IF (I.EQ.IMAX) TEMP = 0.0
      BET(J) = (TEMP + SCAT(J,1)+ BET(J-1)*T)/D4
      DEL(J) = D4/(PTSA(J,1,N)-T+E1(L,K))
  107 CONTINUE
      GO TO 121
  108 IF (I-IVX) 115,109,109
  109 IF (P2(1,IVX,K)) 110,111,110
  110 BET(1) = (P2(2,IP1,K)*D1+ SCAT(1,IVX))/D4
      L = NRGN(1,IVX)
      DEL(1) = D4/(PTSA(1,IVX,N)+E1(L,K))
      IF (INRB.EQ.2) BET(1) = BET(1)+P2(JVX,I,K)*DCONR(1,I,N)/D4
  111 DO 114 J = 2,JVX
      IF (P2(J,IVX,K)) 113,112,113
  112 DEL(J) = 0.0
      GO TO 114
  113 T=D4*DEL(J-1)
      L = NRGN(J,IVX)
      D4 = DCONR(J+1,IVX,N)
      BET(J) = (P2(J+1,IP1,K)*DCONB(J,IVX,N)+ SCAT(J,IVX)+BET(J-1)*T)/D4
      DEL(J) = D4/(PTSA(J,IVX,N)-T+E1(L,K))
      IF (INRB.NE.3) GO TO 114
      IF (((J/2)*2).NE.J) GO TO 114
      IF (J.EQ.JVX) GO TO 114
      BET(J) = BET(J)+P2(JVX,J/2,K)*DCONB(J-1,IVXP1,N)/D4
  114 CONTINUE
      GO TO 121
  115 IF (P2(1,I,K)) 116,117,116
  116 CONTINUE
      L = NRGN(1,I)
      BET(1) = (P2(2,IP1,K)*D1 + SCAT(1,I))/D4
      DEL(1) = D4/(PTSA(1,I,N)+E1(L,K))
      IF (INRB.EQ.2) BET(1) = BET(1)+P2(JVX,I,K)*DCONR(1,I,N)/D4
  117 CONTINUE
      DO 120 J = 2,JVX
      IF (P2(J,I,K)) 119,118,119
  118 DEL(J) = 0.0
      GO TO 120
  119 T=D4*DEL(J-1)
      L = NRGN(J,I)
      D4 = DCONR(J+1,I,N)
      BET(J)=(P2(J+1,IP1,K)*DCONB(J,I,N)+P2(J-1,IP2,K)*DCONB(J-1,IP2,N)+
     &  SCAT(J,I)+BET(J-1)*T)/D4
      DEL(J) = D4/(PTSA(J,I,N)-T+E1(L,K))
  120 CONTINUE
  121 CONTINUE
      GO TO (125,122,123,124),INRB
  122 CONTINUE
      BET(JVX) = BET(JVX)+P2(1,I,K)
      GO TO 125
  123 CONTINUE
      IF (I.EQ.IVX) GO TO 125
      BET(JVX) = BET(JVX)+P2(2*I,IVX,K)
      GO TO 125
  124 CONTINUE
      BET(JVX) = BET(JVX)+P2(JVX,IVXP1-I,K)
  125 TEMP = BET(JVX)*DEL(JVX)
      T = P2(JVX,I,K)
      TMF = T+BETTA*(TEMP-T)
      IF (IEP) 126,130,127
  126 P2(JVX,I,K)=TEMP
      GO TO 131
  127 IF (TMF-TEMP) 129,130,128
  128 TMF = DMIN1(TMF,(TEMP+ T))
      GO TO 130
  129 TMF = DMAX1(TMF,0.5*TEMP)
  130 CONTINUE
      P2 (JVX,I, K) = TMF
  131 DO 138 JJ = 2,JVX
      J = JVXP1-JJ
      T = P2(J,I,K)
      TEMP = DEL(J)*(TEMP+BET(J))
      TMF = T+BETTA*(TEMP-T)
      IF (IEP) 132,136,133
  132 P2(J,I,K)=TEMP
      GO TO 138
  133 IF (TMF-TEMP) 135,136,134
  134 TMF = DMIN1(TMF,(TEMP+ T))
      GO TO 136
  135 TMF = DMAX1(TMF,0.5*TEMP)
  136 CONTINUE
  137 P2 (J,I, K) = TMF
  138 CONTINUE
      IF (NUAC(8)) 139,143,141
  139 L=IVXP1-I
      DO 140J=1,JVX
      M=JVXP1-J
      P2(M,L,K)=P2(J,I,K)
  140 CONTINUE
      GO TO 143
  141 DO 142J=1,JVX
      P2(I,J,K)=P2(J,I,K)
  142 CONTINUE
  143 CONTINUE
      RETURN
      END
