CKLUX-VP-111 ***CITATION*** EIGENVALUE-FLUX FOR 3-D/ CF-EIGN
C
      SUBROUTINE KLUX(NRGNE,E1, B1,B2,B3,B4,B5, SCAC,CONC, P1E,P2E,
     & DCONBE,DCONRE,DCONBK,SOURE,SCATE,PTSAE,NCOMP, F1,SS1,SS2,SS3,SS4,
     & SS5,SSC,SIG,HOL,ONEOV,PVOL,NJJR, BBND,BND,XI, XL,XII, IVX,JVX,
     & KBVX,KVX,LVX,MVX,NVX,IVXP1,JVXP1,KBVXP1,IVZ,KVZ, NSETVX, JIVX,
     & JIP1VX,JP1IXZ,IOVX,IOVZ,A,MEMORY,AIO,IX3738, SPAR, BIEMS,NCRP,
CNN  & NSPA,ZONEN,NNXTRA,NVO)
     & NSPA,ZONEN,NNXTRA,NVO,NRX,WORK1)
CADD
      LOGICAL LFIRST
      COMMON  /CITLOG/   LFIRST
CEND
C
CDEL  INTEGER RGX , MSX , ZNEX , ZDX , WZX
CDEL  PARAMETER ( RGX=100, MSX=211, ZDX=200, ZNEX=1000, WZX=100 )
      INCLUDE  'CITPMINC'
C
      REAL*8 B1
      REAL*8 XLAMDA,XAAMDA,XII,TXX1
      REAL*8 ZPDB,XMU3
      REAL*8 SUMXI,TPTSA,XADB,XPDB,XS1DB,XS2DB, TL,XRDB,CS1S,CS2S,XLL1,
     & D8,XADX,YADX, XLL2,XLL3,XLL4,XLL5,XLL6,XLEK,B2LK,B3LK,B4LK,B5LK,
     & D1,D2,D3,D4,D5, D6,D7,YADB,YPDB,YLEK,YS1S,YS2S,YS1DB,YS2DB,YRDB,
     & SPR50,XLAST
C
      COMMON/ADUBP/SUMXI(ZNEX)
     &                  ,TPTSA,XADB,XPDB,XS1DB,XS2DB, TL,XRDB,CS1S,CS2S,
     &  XLL1,D8,XADX,YADX, XLL2,XLL3,XLL4,XLL5,XLL6,XLEK,B2LK,B3LK,B4LK,
     &  B5LK,D1,D2,D3,D4,D5, D6,D7,YADB,YPDB,YLEK,YS1S,YS2S,YS1DB,YS2DB,
     &  YRDB,SPR50,XLAST
      COMMON/ALSUB/BLSUB(30),TITL1(18),TITL2(18),IMAX,JMAX,KBMAX,KMAX,
     & LMAX,MMAX, NMAX,IMXP1,JMXP1,KBMXP1,NSETMX,NTO,MM1VX,KM1VX,IOIN,
     & IOUT,IOSIG,IOFLX,IO1,IO2,IO3,IO4,IO7,NER(100), IX(200),INNO(100),
     &  NGC(24),IEDG(24),ITMX(24),TIMX(6), GLIM(6),NDPL(24),IEDP1(24),
     & IEDP2(24),IEDP3(24), DPLH(6),NUAC(24),EPI(6),XMIS(6),NSRH(24),
     & XSRH1(6), XTR1(WZX),XTR2(WZX),NXTR1(WZX),NXTR2(WZX),SPARE(200),
     & IXPUT(200),XPUT(200)
      COMMON/AFLUX/BFLUX(30),KXMN8,NIT,NIIT,NIIIT,JXP1,KSCT1,KSCT2,
     & ISTART,IEP, VRGP1,VRGP2,VRGP3,VRG1,VRG2,VRGK1,VRGK2,XABS,PROD,
     & XELK,RMX,RMN,XKEF1,XKEF2,XKEF3,EXFC1,EXFC2,EXFC3, NI3,IEXTR,
     & IRECV,VRGABS,LO3,LO4,XLAMDB,EPI1,EPI2, BETTA,SAMXI,IX25,IX28,I,J,
     &  KB,K,ITMAX,ITIME, BET(MSX),DEL(MSX)
      COMMON/AKADD/KAY(1),K1,K2,K3,K4,K5,K6,K7,K8,K9,K10,K11, K12,K13,
     & K131,K14,K15,K16,K17,K18,K19,K20,K21,K22,K23,K24, K25,K26,K27,
     & K28,K29,K30,K31,K32,K33,K34,K35,K36,K37, K38,K39,K40,K41,K42,K43,
     &  K44,K45,K46,K47,K48,K49, K50,K51,K52,K53,K54,K55,K56,K57,K58,
     & K59, K60,K61,K62, K63,K64,K65,K66,K67,K68,K69,K70,K71,K72,K73,
     & K74,K75, K76,K77,K78,K79,K80,K81,K82,K83,K84,K85,K86,K87, K88,
     & K89,K90, K91,K92,K93,K94,K95,K96,K97,K98, K99,K100,NDATA,KNRGN,
     & KNCOMP, KPVOL,KRVOL,MEMVRY, MEMX
C
      COMMON /CRBNC/ ICONV,ICRBN,NCBSTP,AVZAB(ZNEX)
C     ICRBN IS SET IN CIT1 IF SRAC, OR CRBN IF COREBN
C     ICRBN =0 : SRAC-CITATION, ICRBN=1 : COREBN
CNN
      DIMENSION WORK1(1)
      DIMENSION NRX(JVX*IVX,KBVX)
CNN
C
      DIMENSION NRGNE(JVX,IVX,KBVX),E1(LVX,KVX), B1(MVX,KVX),B2(MVX,KVX)
     & ,B3(MVX,KVX),SCAC(KVX,MVX,KVX),CONC(NVX, MVX),P1E(JIVX ,KBVX) ,
     & P2E(JIVX ,KBVX,KVX), DCONBE(JIP1VX , KBVX,IOVX),DCONRE(JP1IXZ ,
     & KBVX,IOVZ),DCONBK(JIVX , KBVXP1,IOVX), SOURE(JVX,IVX,KBVX),
     & SCATE(JVX,IVX,KBVX),PTSAE(JIVX ,KBVX,IOVX), B4(MVX,KVX),B5(MVX,
     & KVX),NCOMP(LVX)
      DIMENSION F1(KVX ,MVX),SS1(KVX,NVX,NSETVX), SS2(KVX,NVX,NSETVX) ,
     & SS3(KVX,NVX,NSETVX),SS4(KVX,NVX,NSETVX), SS5(KVX,NVX,NSETVX),
     & SSC(KVX,KVX,NVX),HOL(NVX,NSETVX,10), ONEOV(KVX,NSETVX),PVOL(LVX),
     &  NJJR(NVX,NSETVX),SIG(KVX,MVX,10)
      DIMENSION BBND(KVX),BND(6,KVX),XI(KVX,MVX),XL(6,KVX),XII(KVX,MVX)
      DIMENSION A(MEMORY)
      DIMENSION AIO(IX3738)
      DIMENSION SPAR(NCRP,NSPA),BIEMS(KVX)
      DIMENSION ZONEN(NVO),NNXTRA(NVX,NSETVX)
C
      IF (ICRBN.EQ.1) GOTO 100
      ISTART = ICLOCK(0)
  100 CONTINUE
CHH
      K80=NDATA+JIVX*KBVX+1
      IF(NUAC(5).NE.14) THEN
        JVXW=(JVX/2)*2+2
        ELSE
        JVXW=JVX+1
      ENDIF
      K81=K80+(JVXW+1)*IVXP1*KBVX
      K82=K81+(JVXW+1)*IVXP1*KBVX
      K83=K82+(JVXW+1)*IVXP1*(KBVXP1+1)*3
      K84=K83+(JVXW+1)*IVXP1*(KBVXP1+1)
      K85=K84+(JVXW+1)*IVXP1
CHH
CNN
      K86 = K85 + JIVX*KBVX
CITJMOD
       IF (NUAC(17).NE.0) THEN
CITJMOD
      IF( JVX .GE. IVX ) THEN
        JP5K = (JVX + 5)*KBVX
      ELSE
        JP5K = (IVX + 5)*KBVX
      ENDIF
      JP5K3= JP5K*3
CITJMOD
       ELSE
       JP5K3= 0
      END IF
      K86A = K86 + JP5K3
      K86B = K86A + JP5K3
      K86C = K86B + JP5K3
      K86D = K86C + JP5K3
      K86E = K86D + JP5K3
      K86F = K86E + JP5K3
      IF (NUAC(5).EQ.13) THEN
       JP5K3H = JP5K3
       ELSE
       JP5K3H = 0
      END IF
      K86G = K86F + JP5K3H
      K86H = K86G + JP5K3H
CITJMOD
      IF (NUAC(17).NE.0) THEN
        LAST = K86H + 8 - 1
       ELSE
        LAST = K86 - 1
      END IF
      IF (LAST .GT. MEMVRY) THEN
       WRITE(IOUT,2003) LAST,MEMVRY
       CALL EXIT
      END IF
 2003 FORMAT(1H0,' === LACK OF MEMORY IN KLUX ==='//
     >       1H ,' USED MEMORY      :',I10//
     >       1H ,' ALLOCATED MEMORY :',I10)
      IF (NUAC(17) .NE. 0) THEN
        IF (XMIS(2) .GE. 0) THEN
          K = 1
          CALL KINS0(P2E,B2,NRGNE,DCONBE,DCONRE,DCONBK,SCAC,XL, IVX,
     & JVX,KBVX,KVX,LVX,JVXP1,KBVXP1,JIVX,JIP1VX,JP1IXZ,IOVX,IOVZ, PVOL,
     &  NCOMP,MVX,IVXP1,
     &  A(K86),A(K86A),A(K86B),A(K86C),A(K86D),A(K86E),A(K86F),A(K86G),
     &  A(K86H),JP5K)
         ELSE
          DO 201 K = 1,KMAX
           IF (BBND(K) .NE. 0.0) THEN
          CALL KINS0(P2E,B2,NRGNE,DCONBE,DCONRE,DCONBK,SCAC,XL, IVX,
     & JVX,KBVX,KVX,LVX,JVXP1,KBVXP1,JIVX,JIP1VX,JP1IXZ,IOVX,IOVZ, PVOL,
     &  NCOMP,MVX,IVXP1,
     &  A(K86),A(K86A),A(K86B),A(K86C),A(K86D),A(K86E),A(K86F),A(K86G),
     &  A(K86H),JP5K)
           GO TO 202
           END IF
  201     CONTINUE
  202     CONTINUE
        END IF
      END IF
CITJMOD
CNN
      XLAMDA = XLAMDB
      IX(129) = 0
      SPARE(29) = 1.0
      IF (IX(128).GT.0) SPARE(29) = 0.0
      SPR50 = 1.0/SPARE(50)
      DO 101 M = 1,MMAX
      SUMXI(M) = 0.0
      DO 101 K = 1,KMAX
      SUMXI(M) = SUMXI(M)+XI(K,M)
  101 CONTINUE
      IX37 = IX(37)
      IX38 = IX(38)
      IO19 = IX(86)
      IO15 = IX(82)
      IOADJ = IO15
      IF (IX(71).GT.0) IOADJ = IO2
      IF (IX37.GT.0) REWIND IOADJ
      CALL KEGN(XL,P2E,E1,XLAMDA,IVX,JVX,KBVX,KVX,LVX,JIVX)
      XPDB = 1.0
      YPDB = 1.0
      BETTX = BETTA
CADD
      LFIRST = .TRUE.
CEND
      IF (IX(198).NE.0) GO TO 102
      IF ((NGC(2).NE.0).AND.(NUAC(2).EQ.0)) GO TO 103
  102 CONTINUE
      BETTX = 1.0
      IEP = -1
  103 CONTINUE
      IF (IX(5).NE.(-5)) GO TO 105
      DO 104 M=1,MMAX
      DO 104 K=1,KMAX
      XII(K,M) = XI(K,M)
      XI(K,M) = BIEMS(K)
  104 CONTINUE
      IF (IX(132).LE.0) GO TO 105
      IOFS = IX(84)
      REWIND IOFS
  105 CONTINUE
      IRR = IX(10)
      JRR = IX(11)
      KBRR = IX(12)
      KRR = IX(13)
      NRR= (IRR-1)*JVX + JRR
      NUPDTE = 0
      IEND = 0
      KGP1 = KMAX+1
      PNM0 = 0.0
      PNM1 = 0.0
CHH
      CALL KOOP( P2E,SOURE,NRGNE,XII,IVX,JVX,KBVX,KVX, LVX,JIVX,XLAMDA,
     & SIG,PVOL,NCOMP,MVX,A(K85))
CHH   CALL KOOP( P2E,SOURE,NRGNE,XII,IVX,JVX,KBVX,KVX, LVX,JIVX,XLAMDA,
CHH  & SIG,PVOL,NCOMP,MVX)
  106 CONTINUE
      PNM2 = PNM1
      PNM1 = PNM0
      YADX = XADX
      ZPDB = YPDB
      YPDB = XPDB
      YLEK = XLEK
      YS1S = CS1S
      YS2S = CS2S
      YS1DB = XS1DB
      YS2DB = XS2DB
      XMU3 = 0.0
      XADB = 0.0
      XPDB = 0.0
      XLEK = 0.0
      XRDB = 0.0
      XS1DB = 0.0
      XS2DB = 0.0
CHH
CITJ MOD
C     IF(NUAC(5).NE.13) THEN
      CALL KNSD(SCATE,P2E,DCONBE,DCONRE,DCONBK,PTSAE,SOURE,NRGNE, XII,
     & SCAC,P1E,E1,IVX,JVX,KBVX,KVX,IVXP1,JVXP1,KBVXP1,LVX, JIVX,JIP1VX,
     & JP1IXZ,IOVX,IOVZ,SPAR,BIEMS,NCRP,NSPA, SIG,PVOL,NCOMP,MVX,AIO,
     & IX3738,XLAMDA,XI,XL,B2,IOADJ,IOFS,KGP1,
CNN  & A(K80),A(K81),A(K82),A(K83),A(K84),A(K85),JVXW)
     & A(K80),A(K81),A(K82),A(K83),A(K84),A(K85),JVXW,WORK1,
     & A(K86),A(K86A),A(K86B),A(K86C),A(K86D),A(K86E),A(K86F),
CITJ MOD
     & A(K86G),A(K86H),JP5K,BBND)
C    & A(K86G),A(K86H),JP5K)
C
C                       ELSE
C     CALL KNSDO(SCATE,P2E,DCONBE,DCONRE,DCONBK,PTSAE,SOURE,NRGNE, XII,
C    & SCAC,P1E,E1,IVX,JVX,KBVX,KVX,IVXP1,JVXP1,KBVXP1,LVX, JIVX,JIP1VX,
C    & JP1IXZ,IOVX,IOVZ,SPAR,BIEMS,NCRP,NSPA, SIG,PVOL,NCOMP,MVX,AIO,
C    & IX3738,XLAMDA,XI,XL,B2,IOADJ,IOFS,KGP1)
C                       ENDIF
CITJ MOD
C
      IF ((NUAC(3).GT.0).OR.(IX(24).GT.0)) GO TO 110
CHH
      CALL KBPR(P2E,B1,B2,B3,B4,B5,NRGNE,JVX,IVX,KBVX,KVX, LVX,JIVX,SIG,
CNN  & PVOL,NCOMP,MVX,A(K85))
     & PVOL,NCOMP,MVX,WORK1,WORK1)
CHH   CALL KBPR(P2E,B1,B2,B3,B4,B5,NRGNE,JVX,IVX,KBVX,KVX, LVX,JIVX,SIG,
CHH  & PVOL,NCOMP,MVX)
      XELK = XLEK
      XKEF2 = XKEF1
      SPARE(43) = XLAMDA
CCCC  XPDB = XPDB*SUMXI
      IF (YPDB.NE.ZPDB) XMU3 = (XPDB-YPDB)/(YPDB-ZPDB)
      XADX = XADB + XRDB
C***************************SEARCH OPTIONS*****************************
      IF ((IX(5).EQ.0).OR.(IX(5).GE.2)) GO TO 107
      CALL GINS(B1,B3,B4,B5,KVX,LVX,XLAMDA,MVX)
      IF (IX(5).EQ.(-5)) GO TO 109
      GO TO 108
  107 CONTINUE
      XLAMDA = (XLEK+XADX)/XPDB
      XKEF1 = 1.0/XLAMDA
      VRGK1 = ABS(XKEF2/XKEF1-1.0)
  108 CONTINUE
      XABS = XADX + XLAMDA*XS1DB
      PROD = XPDB + XLAMDA*XS2DB
      SPARE(48) = XS1DB
      SPARE(49) = XS2DB
      GO TO 110
  109 CONTINUE
      PROD = XPDB
      XABS = XADX
      IF (IX(132).GT.0) REWIND IOFS
  110 CONTINUE
      IF (IX37.GT.0) REWIND IOADJ
      IF (BETTA-1.0) 111,113,111
  111 IF (IEP) 112,113,113
  112 IEP=1
  113 CONTINUE
  114 CONTINUE
      IX(134) = 0
      IF ((NUAC(3).GT.0).OR.(IX(24).GT.0)) GO TO 119
      XABT = ABS(XABS)
CUNIX IF ((XABT.LT.1.0E+40).AND.(XABT.GT.1.0E-10)) GO TO 119
      IF ((XABT.LT.1.0E+35).AND.(XABT.GT.1.0E-10)) GO TO 119
      UP = 1.0E-30
      IF (XABT.LT.1.0E-10) UP = 1.0E+30
      IF (NI3.LE.3) GO TO 119
      IF (VRGP2.EQ.0.0) GO TO 119
      IF ((VRGP1/VRGP2).GE.1.0) GO TO 119
CHH
      DO 115 K = 1,KVX
      DO 115 KB= 1,KBVX
      DO 115 JI= 1,JIVX
  115 P2E(JI,KB,K) = P2E(JI,KB,K)*UP
CHH
      PNM1 = PNM1*UP
      PNM2 = PNM2*UP
      IX(134) = 1
      IF (IX(5).NE.(-5)) GO TO 119
      XLAMDA = XLAMDA*UP
  119 CONTINUE
      P2RR = P2E(NRR ,KBRR,KRR)
CUNIX IF ((P2RR.GT.0.0).AND.(P2RR.LT.1.0E+60)) GO TO 120
      IF ((P2RR.GT.0.0).AND.(P2RR.LT.1.0E+35)) GO TO 120
      WRITE(IOUT,1002)JRR,IRR,KBRR,KRR,P2RR
      WRITE(IOUT,2000)
      IF((P2RR.LE.0.0).AND.(NUAC(18).GT.0)) GO TO 120
      STOP
  120 CONTINUE
      NUPDTE = NUPDTE+1
      IF (NSRH(11).EQ.0) NUPDTE = -1
  121 CONTINUE
CHH
      CALL KOOP( P2E,SOURE,NRGNE,XII,IVX,JVX,KBVX,KVX, LVX,JIVX,XLAMDA,
     & SIG,PVOL,NCOMP,MVX,A(K85))
CHH   CALL KOOP( P2E,SOURE,NRGNE,XII,IVX,JVX,KBVX,KVX, LVX,JIVX,XLAMDA,
CHH  & SIG,PVOL,NCOMP,MVX)
      IF (RMN.GE.0.0) GO TO 122
      WRITE(IOUT,1002)
      WRITE(IOUT,2000)
      IF(NUAC(18).GT.0) GO TO 122
      STOP
  122 CONTINUE
      PNM0 = P2E(NRR ,KBRR,KRR)
      P2DOM = 2.0*PNM1-PNM2-PNM0
      IF (P2DOM.NE.0.0) PNM = (PNM0-PNM1)/P2DOM
      SPARE(35) = PNM
      IF (IX(5).GE.2.AND.IX(73).EQ.2) GO TO 136
      CALL EXTR
      IX(129) = 0
      XT1 = SPARE(31)
      XT2 = SPARE(32)
      XT3 = SPARE(33)
      XT4 = SPARE(34)
      IF (IX(32)) 136,136,123
  123 CONTINUE
      REWIND IO19
      IEP = -1
      DO 129 KT1=1,KMAX
      IF(IX(24).GT.0) THEN
        K=KGP1-KT1
        ELSE
        K=KT1
      ENDIF
      READ(IO19) P1E
CHH
      IF(IX(134).NE.1) THEN
        DO 126 KB=1,KBVX
        DO 126 JI=1,JIVX
  126     P2E(JI,KB,K)=(P2E(JI,KB,K)-P1E(JI,KB))*EXFC1+P2E(JI,KB,K)
        ELSE
        DO 127 KB=1,KBVX
        DO 127 JI=1,JIVX
  127     P2E(JI,KB,K)=(P2E(JI,KB,K)-P1E(JI,KB)*UP)*EXFC1+P2E(JI,KB,K)
      ENDIF
CHH
  129 CONTINUE
      REWIND IO19
      IF ((NUAC(3).GT.0).OR.(IX(24).GT.0)) GO TO 135
      D1 = XPDB+(XPDB-YPDB)*EXFC1
      D2 = XADX + (XADX-YADX)*EXFC1
      D3 = XLEK+(XLEK-YLEK)*EXFC1
C***************************SEARCH OPTIONS*****************************
      IF ((IX(5).EQ.0).OR.(IX(5).GE.2)) GO TO 132
      IF (IX(5).EQ.(-5)) GO TO 133
      D6 = XS1DB+(XS1DB-YS1DB)*EXFC1
      D7 = XS2DB+(XS2DB-YS2DB)*EXFC1
      D8 = XLAMDA
      TL = D2+D3+D8*D6
      XKEF1 = (D1+D8*D7)/TL
      XAAMDA = (SPR50*D1-D2-D3)/(D6-SPR50*D7)
      TXX1 = SPARE(51)
      IF (SPARE(51).GT.0.0) GO TO 130
      XLAMDA = DMAX1(XAAMDA,TXX1)
      GO TO 131
  130 XLAMDA = DMIN1(XAAMDA,TXX1)
  131 CONTINUE
      GO TO 135
  132 CONTINUE
      XLAMDA = (D3+D2)/D1
      XKEF1 = 1.0/XLAMDA
      GO TO 135
  133 CONTINUE
      D8 = (D3 + D2 - D1)/SPARE(88)
      IF (D8.GE.0.0) GO TO 134
      IF (D8.LT.XLAMDA) GO TO 135
  134 XLAMDA = D8
  135 CONTINUE
CHH
      CALL KOOP( P2E,SOURE,NRGNE,XII,IVX,JVX,KBVX,KVX, LVX,JIVX,XLAMDA,
     & SIG,PVOL,NCOMP,MVX,A(K85))
CHH   CALL KOOP( P2E,SOURE,NRGNE,XII,IVX,JVX,KBVX,KVX, LVX,JIVX,XLAMDA,
CHH  & SIG,PVOL,NCOMP,MVX)
  136 CONTINUE
      IF (NUAC(3)) 138,138,137
  137 CONTINUE
      CALL KDUE(SCAC, RESLM,RESSA, P2E,NRGNE, SOURE,DCONRE,DCONBE,
     & DCONBK,XI, IVX,JVX,KBVX,KVX,LVX,IVXP1,JVXP1, KBVXP1,IVZ,KVZ,
     & JIVX,JIP1VX,JP1IXZ,IOVX,IOVZ,A,MEMORY,AIO,IX3738, XLAMDA,SIG,
     & PVOL,NCOMP,MVX)
  138 CONTINUE
      INOW = ICLOCK(0)
      XWACH = (FLOAT(INOW)-FLOAT(ISTART))/6000.0
      SPARE(66) = XWACH
      T1 = ABS(2.0*VRG1)
      T2 = ABS(VRGABS)
      IF (T1-T2) 140,140,139
  139 VRGABS = T1
  140 CONTINUE
      CALL RQED(IX(101),IND)
      IF (IND.NE.0) GO TO 141
      CALL ITED(XLAMDA,XMU3,BETTX,XT1,XT2,XT3)
  141 CONTINUE
      IF (IX(5).GE.2.AND.IX(73).EQ.2) GO TO 169
  142 IWACH = (INOW-ISTART)/6000
      IS1 = 0
      IF (IX(6)) 144,144,143
  143 NR = 16
      GO TO 161
  144 CONTINUE
      IF (IEND.GT.0) GO TO 152
      IF (IX(5).NE.1) GO TO 146
      UPSIG = 0
      IF (NUPDTE.LT.NSRH(11)) GO TO 146
      IF (NIIT.GT.0) GO TO 146
      NGOTO = 1
      NUPDTE = 0
  145 CONTINUE
      CALL UDTE(CONC,SS1,SS2,SS3,SS4,SS5,SSC,SIG,HOL,ONEOV, SCAC,NJJR,
     & BND,BBND,ZONEN,NNXTRA,XI,XLAMDA,A(K19), MVX,NVX,KVX,NSETVX,NVO)
      CALL KNST(NRGNE, SCAC,DCONBE, DCONRE, DCONBK,F1,SIG,PTSAE,NCOMP,
     & PVOL,BBND,BND,IVX,JVX,KBVX,KVX,LVX, MVX,IVXP1,JVXP1,KBVXP1,IVZ,
     & KVZ, JIVX,JIP1VX,JP1IXZ,IOVX,IOVZ,A, MEMORY,AIO,IX3738)
      IX(129) = 1
      UPSIG = 1
      GO TO (146,151),NGOTO
  146 CONTINUE
      BETTX = BETTA
      IF (IEP.LT.0) BETTX = 1.0
      IF (NI3.LT.3) GO TO 147
      IF (VRGP1.GE.EPI1) GO TO 147
      IF (VRGK1.GE.EPI2) GO TO 147
      GO TO 149
  147 IF (IWACH.GE.ITIME) GO TO 1148
      IF (NIT.GE.ITMAX) GO TO 148
      GO TO 106
 1148 ICONV=1
  148 IS1 = 1
  149 CONTINUE
  150 CONTINUE
C**************************SEARCH OPTION********************************
      IF (IX(5).NE.1) GO TO 153
      IF (UPSIG.EQ.1) GO TO 151
      NGOTO = 2
      GO TO 145
  151 IF (NSRH(11).EQ.0) GO TO 152
      IEND = 1
      GO TO 106
  152 CONTINUE
  153 CONTINUE
      IF (IX(24).EQ.0) SPARE(56) = XLEK+XABS
      CALL RQED(IX(101),IND)
      IF (IND.EQ.0) GO TO 154
      CALL ITED(XLAMDA,XMU3,BETTX,XT1,XT2,XT3)
  154 CONTINUE
C
C***************************SEARCH OPTIONS******************************
      IF ((IX(5).EQ.0).OR.(IX(5).GE.2)) GO TO 155
      IF (IX(5).EQ.(-5)) GO TO 157
      GO TO 158
  155 CONTINUE
      IF (IX(24).EQ.0) GO TO 156
      WRITE(IOUT,1005)XWACH
      GO TO 158
  156 CONTINUE
      WRITE(IOUT,1006)XWACH
      GO TO 158
  157 WRITE(IOUT,1000) XWACH
  158 CONTINUE
C     IF (IX(5).NE.1) GO TO 163
C*****CALL EDSR(CONC,NJJR,MVX,NVX,NSETVX)
C 163 CONTINUE
      IF (IS1) 163,163,159
  159 CONTINUE
      IF (NGC(15).EQ.0) GO TO 162
      IF (NGC(15).EQ.2) GO TO 160
      IF (VRGP2.EQ.0.0) GO TO 162
      IF ((VRGP1/VRGP2).GE.1.0) GO TO 160
      GO TO 162
  160 NR = 13
  161 WRITE(IOUT,1007) NR
      IF(NR.EQ.13) WRITE(IOUT,2001)
      IF(NR.EQ.16) WRITE(IOUT,2002)
      STOP
  162 CONTINUE
      WRITE(IOUT,1010)
  163 CONTINUE
      IF (NUAC(3).EQ.0) GO TO 164
      WRITE(IOUT,1001)
      STOP
  164 IF (NGC(18)) 166,165,165
  165 CONTINUE
      IF (IX(5).EQ.(-5)) GO TO 166
      CALL KDUE(SCAC, RESLM,RESSA, P2E,NRGNE, SOURE,DCONRE,DCONBE,
     & DCONBK,XI, IVX,JVX,KBVX,KVX,LVX,IVXP1,JVXP1, KBVXP1,IVZ,KVZ,
     & JIVX,JIP1VX,JP1IXZ,IOVX,IOVZ,A,MEMORY,AIO,IX3738, XLAMDA,SIG,
     & PVOL,NCOMP,MVX)
      WRITE(IOUT,1009)RESSA,RESLM
  166 CONTINUE
      XLAMDB = XLAMDA
      IF (IX(5).NE.(-5)) GO TO 168
      DO 167 M=1,MMAX
      DO 167 K=1,KMAX
      BIEMS(K) = XI(K,1)
      XI(K,M) = XII(K,M)
  167 CONTINUE
  168 CONTINUE
  169 CONTINUE
      RETURN
 1000 FORMAT(1H0,'END OF FIXED SOURCE CALCULATION - ITERATION TIME',
     & 0PF7.3,' MINUTES')
 1001 FORMAT(1H0,'FLUX CALCULATION WAS DONE WITH THE RESIDUES - NOW CALL
     & EXIT')
 1002 FORMAT(1H0'ERROR STOP NUMBER 12'4I4,1PE13.5)
 1003 FORMAT(1H I5,1PE17.5,0P4F10.5,F14.6,1PE14.5)
 1004 FORMAT(1H I5,1PE17.5,0P4F10.5/ 1H 5X,1PE17.5,3X,
     & 'EXTRAPOLATION WITH'0PF13.4,F20.6,1PE14.5)
 1005 FORMAT(1H0'END OF ADJOINT CALCULATION - ITERATION TIME'0PF7.3,
     & ' MINUTES')
 1006 FORMAT(1H0'END OF EIGENVALUE CALCULATION - ITERATION TIME'0PF7.3,
     & ' MINUTES')
 1007 FORMAT(1H0,'ERROR STOP',I3)
 1008 FORMAT(1H073X,'NEUTRON BALANCE KEFFECTIVE'0PF14.7)
 1009 FORMAT(1H0'CONVERGENCE INDICATION BY MINIMIZING THE SUM OF THE SQU
     &ARES OF THE RESIDUES - RELATIVE ABSORPTION'F11.7,'   K'F11.7)
 1010 FORMAT(1H0/1H0'**********WARNING - FLUX CALCULATION NOT CONVERGED*
     &*********'/1H0/1H0)
 2000 FORMAT(1H ,'A NEGATIVE FLUX WAS CALCULATED, OR FLUX WAS CALCULAT',
     &       'ED GREATER THAN 1.0E+35')
CUNIX&       'ED GREATER THAN 1.0E+60')
 2001 FORMAT(1H ,'THE LIMIT ON MULTIPLICATION FACTOR, MACHINE TIME, OR',
     &       ' THE NUMBER OF ITERATIONS WAS EXCEEDED IN SOME LOOP CALC',
     &       'ULATION'/' AND THE OPTION TO TERMINATE (NGC15, SECTION ',
     &       '001) IS EXERCISED.')
 2002 FORMAT(1H ,'NO INITIAL VALUES OF THE SEARCH PARAMETERS (1/V,B**2',
     &       ', OR CONCENTRATIONS) WERE INPUT FOR A DIRECT SEARCH.'    )
      END
