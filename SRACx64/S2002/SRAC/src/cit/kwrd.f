CKWRD --121***CITATION*** LINE RELAXATION ON ROWS 3-D/ CF-KNSD
C
      SUBROUTINE KWRD(SCATE,P2E,DCONBE,DCONRE,DCONBK,PTSAE,TSOUR, NRGNE,
     &  E1,LVX, IVX,JVX,KBVX,KVX,IVXP1,JVXP1,KBVXP1, JIVX,JIP1VX,JP1IXZ,
     &  IOVX,IOVZ)
C
CDEL  INTEGER RGX , MSX , ZNEX , ZDX , WZX
CDEL  PARAMETER ( RGX=100, MSX=211, ZDX=200, ZNEX=1000, WZX=100 )
      INCLUDE  'CITPMINC'
C
      COMMON/ALSUB/BLSUB(30),TITL1(18),TITL2(18),IMAX,JMAX,KBMAX,KMAX,
     & LMAX,MMAX, NMAX,IMXP1,JMXP1,KBMXP1,NSETMX,NTO,MM1VX,KM1VX,IOIN,
     & IOUT,IOSIG,IOFLX,IO1,IO2,IO3,IO4,IO7,NER(100), IX(200),INNO(100),
     &  NGC(24),IEDG(24),ITMX(24),TIMX(6), GLIM(6),NDPL(24),IEDP1(24),
     & IEDP2(24),IEDP3(24), DPLH(6),NUAC(24),EPI(6),XMIS(6),NSRH(24),
     & XSRH1(6), XTR1(WZX),XTR2(WZX),NXTR1(WZX),NXTR2(WZX),SPARE(200),
     & IXPUT(200),XPUT(200)
      COMMON/AFLUX/BFLUX(30),KXMN8,NIT,NIIT,NIIIT,JXP1,KSCT1,KSCT2,
     & ISTART,IEP, VRGP1,VRGP2,VRGP3,VRG1,VRG2,VRGK1,VRGK2,XABS,PROD,
     & XLEK,RMX,RMN,XKEF1,XKEF2,XKEF3,EXFC1,EXFC2,EXFC3, NI3,IEXTR,
     & IRECV,VRGABS,LO3,LO4,XLAMDA,EPI1,EPI2, BETTA,SUMXI,IX25,IX28,I,J,
     &  KB,K,ITMAX,ITIME, BET(MSX),DEL(MSX)
C
      DIMENSION SCATE(JVX,IVX,KBVX),P2E(JIVX,KBVX,KVX), DCONBE(JIP1VX,
     & KBVX,IOVX),DCONRE(JP1IXZ,KBVX,IOVZ), DCONBK(JIVX,KBVXP1,IOVX),
     & PTSAE(JIVX,KBVX,IOVX)
      DIMENSION E1(LVX,KVX),NRGNE(JVX,IVX,KBVX)
      DIMENSION TSOUR(MSX)
C
CCCC ********** SUBSCRIPT DEFINITIONS (KWRD E-070) ********* CCCCC
C    NEW         OLD            NEW         OLD
C     N1         J,I             N5 *     J+1,I
C     N2         J,I-1           N6       JVX,I
C     N3         J,I+1           N14        M,L
C     N4         N/A             N15        I,J
C     N9       JVX,J             N8         I,IVX
C     N10      JVX,IVXP1-I
C
C     INRB = 1  ORDINARY
C     INRB = 2  PERIODIC(REPEATING)  RELAXATION DONE IN KPER
C     INRB = 3  90 DEGREE ROTATIONAL
C     INRB = 4  180 DEGREE ROTATIONAL
C
      INRB = IX(72) + 1
      ASSIGN 111 TO ISYM
      IF (INRB.EQ.3) ASSIGN 108 TO ISYM
      IF (INRB.EQ.4) ASSIGN 110 TO ISYM
      N = IX(20)
      DO 136 KB=1,KBVX
      ASSIGN 100 TO IBR1
      IF (KB.LE.1) ASSIGN 101 TO IBR1
      ASSIGN 102 TO IBR2
      IF (KB.GE.KBVX) ASSIGN 103 TO IBR2
      KBM1 = KB - 1
      KBP1 = KB + 1
      DO 135 I=1,IVX
      ASSIGN 104 TO IBR3
      IF (I.LE.1) ASSIGN 105 TO IBR3
      ASSIGN 106 TO IBR4
      IF (I.GE.IVX) ASSIGN 107 TO IBR4
      IM1 = I - 1
      IP1 = I + 1
      NN1 = IM1*JVX
      NN2 = NN1 - JVX
      NN3 = NN1 + JVX
      N1 = NN1
      N2 = NN2
      N3 = NN3
      DO 112 J=1,JVX
      N1 = N1 + 1
      N2 = N2 + 1
      N3 = N3 + 1
      CKSS = SCATE(J,I,KB)
      GO TO IBR1, (100,101)
  100 CKSS = CKSS + P2E(N1 ,KBM1,K)*DCONBK(N1 ,KB,N)
  101 GO TO IBR2, (102,103)
  102 CKSS = CKSS + P2E(N1 ,KBP1,K)*DCONBK(N1 ,KBP1,N)
  103 GO TO IBR3, (104,105)
  104 CKSS = CKSS + P2E(N2 ,KB,K)*DCONBE(N1 ,KB,N)
  105 GO TO IBR4, (106,107)
  106 CKSS = CKSS + P2E(N3 ,KB,K)*DCONBE(N3 ,KB,N)
  107 GO TO ISYM, (111,108,110)
  108 CONTINUE
      IF (J.NE.JMAX) GO TO 109
      IF (I.EQ.IMAX) GO TO 109
      N5 = I*JVXP1
      N8 = JIVX - JVX + I
      CKSS = CKSS + P2E(N8,KB,K)*DCONRE(N5,KB,N)
  109 IF (I.NE.IMAX) GO TO 111
      IF (J.EQ.JMAX) GO TO 111
      N3 = JIVX + J
      N9 = J*JVX
      CKSS = CKSS + P2E(N9,KB,K)*DCONBE(N3,KB,N)
      GO TO 111
  110 CONTINUE
      IF (J.NE.JMAX) GO TO 111
      N5 = I*JVXP1
      N10 = (IVXP1-I)*JVX
      CKSS = CKSS + P2E(N10,KB,K)*DCONRE(N5,KB,N)
  111 TSOUR(J) = CKSS
  112 CONTINUE
      NN4 = IM1*JVXP1
      N4 = NN4 + 1
      N5 = N4 + 1
      N1 = NN1 + 1
      D4 = DCONRE(N5 ,KB,N)
      IF (P2E(N1,KB,K).EQ.0.0) GO TO 113
      L = NRGNE(1,I,KB)
      BET(1) = TSOUR(1)/D4
      DEL(1) = D4/(PTSAE(N1 ,KB,N) + E1(L,K))
      GO TO 114
  113 DEL(1) = 0.0
  114 CONTINUE
      DO 116 J=2,JVX
      N1 = N1 + 1
      N5 = N5 + 1
      IF (P2E(N1,KB,K).EQ.0.0) GO TO 115
      L = NRGNE(J,I,KB)
      T = D4*DEL(J-1)
      D4 = DCONRE(N5 ,KB,N)
      BET(J) = ( TSOUR(J) + BET(J-1)*T)/D4
      DEL(J) = D4/(PTSAE(N1 ,KB,N) + E1(L,K) - T)
      GO TO 116
  115 DEL(J) = 0.0
  116 CONTINUE
      N6 = NN3
      TEMP=BET(JVX)*DEL(JVX)
      T=P2E(N6 ,KB,K)
      TMF=T+BETTA*(TEMP-T)
      IF (IEP) 117,121,118
  117 P2E(N6 ,KB,K)=TEMP
      GO TO 122
  118 IF (TMF-TEMP) 120,121,119
  119 TMF=AMIN1(TMF,(TEMP+T))
      GO TO 121
  120 TMF=AMAX1(TMF,0.5*TEMP)
  121 CONTINUE
      P2E(N6 ,KB,K)=TMF
  122 DO 129JJ=2,JVX
      J=JVXP1-JJ
      N1= NN1 + J
      T=P2E(N1 ,KB,K)
      TEMP=DEL(J)*(TEMP+BET(J))
      TMF=T+BETTA*(TEMP-T)
      IF (IEP) 123,127,124
  123 P2E(N1 ,KB,K)=TEMP
      GO TO 129
  124 IF (TMF-TEMP) 126,127,125
  125 TMF=AMIN1(TMF,(TEMP+T))
      GO TO 127
  126 TMF=AMAX1(TMF,0.5*TEMP)
  127 CONTINUE
  128 P2E(N1 ,KB,K)=TMF
  129 CONTINUE
      IF (NUAC(8)) 130,134,132
  130 L=IVXP1-I
      NN7= (L-1)*JVX
      DO 131J=1,JVX
      M=JVXP1-J
      N1= NN1 + J
      N14= NN7 + M
      P2E(N14,KB,K)=P2E(N1 ,KB,K)
  131 CONTINUE
      GO TO 134
  132 DO 133J=1,JVX
      N1= NN1 + J
      N15= (J-1)*JVX + I
      P2E(N15,KB,K)=P2E(N1 ,KB,K)
  133 CONTINUE
  134 CONTINUE
  135 CONTINUE
  136 CONTINUE
      RETURN
      END
