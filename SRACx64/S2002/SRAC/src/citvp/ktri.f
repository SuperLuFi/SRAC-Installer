CKTRI-VP-121***CITATION*** LINE RELAXATION ON ROWS 3-D/ CF-KNSD
C
CHH
      SUBROUTINE KTRI(SCATE,P2E,DCONBE,DCONRE,DCONBK,PTSAE,TSOUR, NRGNE,
     &  E1,LVX, IVX,JVX,KBVX,KVX,IVXP1,JVXP1,KBVXP1, JIVX,JIP1VX,JP1IXZ,
     &  IOVX,IOVZ,WSC,WPT,WDC,P2F,P2N,JIM1)
CHH   SUBROUTINE KTRI(SCATE,P2E,DCONBE,DCONRE,DCONBK,PTSAE,TSOUR, NRGNE,
C    &  E1,LVX, IVX,JVX,KBVX,KVX,IVXP1,JVXP1,KBVXP1, JIVX,JIP1VX,JP1IXZ,
CHH  &  IOVX,IOVZ)
C
CDEL  INTEGER RGX , MSX , ZNEX , ZDX , WZX
CDEL  PARAMETER ( RGX=100, MSX=211, ZDX=200, ZNEX=1000, WZX=100 )
      INCLUDE  'CITPMINC'
C
      COMMON/ALSUB/BLSUB(30),TITL1(18),TITL2(18),IMAX,JMAX,KBMAX,KMAX,
     & LMAX,MMAX, NMAX,IMXP1,JMXP1,KBMXP1,NSETMX,NTO,MM1VX,KM1VX,IOIN,
     & IOUT,IOSIG,IOFLX,IO1,IO2,IO3,IO4,IO7,NER(100), IX(200),INNO(100),
     &  NGC(24),IEDG(24),ITMX(24),TIMX(6), GLIM(6),NDPL(24),IEDP1(24),
     & IEDP2(24),IEDP3(24), DPLH(6),NUAC(24),EPI(6),XMIS(6),NSRH(24),
     & XSRH1(6), XTR1(WZX),XTR2(WZX),NXTR1(WZX),NXTR2(WZX),SPARE(200),
     & IXPUT(200),XPUT(200)
      COMMON/AFLUX/BFLUX(30),KXMN8,NIT,NIIT,NIIIT,JXP1,KSCT1,KSCT2,
     & ISTART,IEP, VRGP1,VRGP2,VRGP3,VRG1,VRG2,VRGK1,VRGK2,XABS,PROD,
     & XLEK,RMX,RMN,XKEF1,XKEF2,XKEF3,EXFC1,EXFC2,EXFC3, NI3,IEXTR,
     & IRECV,VRGABS,LO3,LO4,XLAMDA,EPI1,EPI2, BETTA,SUMXI,IX25,IX28,I,J,
     &  KB,K,ITMAX,ITIME, BET(MSX),DEL(MSX)
C
      REAL    P2E(JIVX,KBVX,KVX)
C
CHHHH
      REAL    WSC(0:JIM1,KBVX),WPT(0:JIM1,KBVX)
      REAL    WDC(0:JIM1,0:KBVXP1,3)
      REAL    P2F(0:JIM1,0:KBVXP1),P2N(0:JIM1)
CHHHH
C
C     INRB = 1  ORDINARY
C     INRB = 2  PERIODIC(REPEATING)  RELAXATION DONE IN KPER
C     INRB = 3  90 DEGREE ROTATIONAL
C     INRB = 4  180 DEGREE ROTATIONAL
C
      INRB = IX(72)+1
      N = IX(20)
      JP2=JVX+2
      JIE=JP2*IVX-2
C
C********( JI  )=( ODD    )**+*********+*********+*********+*********+
C
      DO 700 KB=1,KBVX
C
      IF( INRB.EQ.2 ) THEN
*VOCL LOOP,NOVREC
        DO 190 JI=0,JIE-JVX,JP2
          P2F(JI,KB)      =P2F(JI+JVX,KB)
  190     P2F(JI+JVXP1,KB)=0.0
C
      ELSE
*VOCL LOOP,NOVREC
        DO 192 JI=0,JIE-JVX,JP2
          P2F(JI,KB)      =0.0
  192     P2F(JI+JVXP1,KB)=0.0
      ENDIF
C
      DO 200 JI=1,JIE,2
CKSK    IF( P2F(JI,KB).NE.0.0 ) THEN
        IF( P2F(JI,KB).NE.0.0.AND.WPT(JI,KB).NE.0.0 ) THEN
          P2N(JI) =( WSC(JI,KB)
     &            +WDC(JI,KB,1)*P2F(JI-1,KB)
     &            +WDC(JI,KB,2)*P2F(JI-JP2+1,KB)
     &            +WDC(JI,KB,3)*P2F(JI,KB-1)
     &            +WDC(JI+1,KB,1)*P2F(JI+1,KB)
     &            +WDC(JI,KB+1,3)*P2F(JI,KB+1) )
     &            /WPT(JI,KB)
        ELSE
          P2N(JI) = 0.0
        ENDIF
  200 CONTINUE
C
C
      IF( IEP ) 310,330,350
  310 DO 320 JI=1,JIE,2
        P2F(JI,KB)=P2N(JI)
  320 CONTINUE
      GO TO 370
C
  330 DO 340 JI=1,JIE,2
        P2F(JI,KB)=(P2N(JI)-P2F(JI,KB))*BETTA+P2F(JI,KB)
  340 CONTINUE
      GO TO 370
C
  350 DO 360 JI=1,JIE,2
        TMF=(P2N(JI)-P2F(JI,KB))*BETTA+P2F(JI,KB)
        IF(TMF-P2N(JI)) 352,356,354
  352     TMF=AMAX1(TMF,P2N(JI)*0.5)
          GO TO 356
  354     TMF=AMIN1(TMF,P2N(JI)+P2F(JI,KB))
  356     P2F(JI,KB)=TMF
  360 CONTINUE
C
  370 CONTINUE
C
C
C********( JI  )=( EVEN    )*+*********+*********+*********+*********+
C
C
      DO 400 JI=0,JIE-JVX,JP2
  400   P2F(JI,KB)=0.0
      IF( INRB.EQ.1 ) THEN
        DO 402 JI=JVXP1,JIE+1,JP2
  402     P2F(JI,KB)=0.0
C
      ELSE IF( INRB.EQ.2 ) THEN
*VOCL LOOP,NOVREC
        DO 404 JI=JVXP1,JIE+1,JP2
          P2F(JI-JVXP1,KB)=0.0
  404     P2F(JI,KB)      =P2F(JI-JVX,KB)
C
      ELSE IF( INRB.EQ.3 ) THEN
*VOCL LOOP,NOVREC
        DO 406 JI=JVXP1,JIE+1,JP2
          JE=((JI+1)/JP2)*2+JIE-JVX
          P2F(JI,KB)      =P2F(JE,KB)
  406     P2F(JE+JVXP1,KB)=P2F(JI-1,KB)
C
      ELSE
*VOCL LOOP,NOVREC
        DO 408 JI=JVXP1,JIE+1,JP2
  408     P2F(JI,KB)=P2F(JIE+JVXP1-JI,KB)
      ENDIF
C
C
      DO 410 JI=2,JIE,2
CKSK    IF( P2F(JI,KB).NE.0.0 ) THEN
        IF( P2F(JI,KB).NE.0.0.AND.WPT(JI,KB).NE.0.0 ) THEN
          P2N(JI) =( WSC(JI,KB)
     &            +WDC(JI,KB,1)*P2F(JI-1,KB)
     &            +WDC(JI,KB,3)*P2F(JI,KB-1)
     &            +WDC(JI+1,KB,1)*P2F(JI+1,KB)
     &            +WDC(JI+JP2-1,KB,2)*P2F(JI+JP2-1,KB)
     &            +WDC(JI,KB+1,3)*P2F(JI,KB+1) )
     &            /WPT(JI,KB)
        ELSE
          P2N(JI) = 0.0
        ENDIF
  410 CONTINUE
C
C
      IF( IEP ) 510,530,550
  510 DO 520 JI=2,JIE,2
        P2F(JI,KB)=P2N(JI)
  520 CONTINUE
      GO TO 570
C
  530 DO 540 JI=2,JIE,2
        P2F(JI,KB)=(P2N(JI)-P2F(JI,KB))*BETTA+P2F(JI,KB)
  540 CONTINUE
      GO TO 570
C
  550 DO 560 JI=2,JIE,2
        TMF=(P2N(JI)-P2F(JI,KB))*BETTA+P2F(JI,KB)
        IF(TMF-P2N(JI)) 552,556,554
  552     TMF=AMAX1(TMF,P2N(JI)*0.5)
          GO TO 556
  554     TMF=AMIN1(TMF,P2N(JI)+P2F(JI,KB))
  556     P2F(JI,KB)=TMF
  560 CONTINUE
C
  570 CONTINUE
C
  700 CONTINUE
C
C
      RETURN
      END
