CESET --- SETUP FLUXES AND DELAYED NEUTRON DATA FOR ELBT /CF-ELBT
C
      SUBROUTINE ESET(P1E,P2E,P2,SIG,UTIL,UTILE,SOURE,XII,XI,JVX,IVX,
     & KBVX,KVX,MVX,JIVX,IDELAY)
C
CDEL  INTEGER RGX , MSX , ZNEX , ZDX , WZX
CDEL  PARAMETER ( RGX=100, MSX=211, ZDX=200, ZNEX=1000, WZX=100 )
      INCLUDE  'CITPMINC'
C
      REAL*8 P2,XII
C
      COMMON/ALSUB/BLSUB(30),TITL1(18),TITL2(18),IMAX,JMAX,KBMAX,KMAX,
     & LMAX,MMAX, NMAX,IMXP1,JMXP1,KBMXP1,NSETMX,NTO,MM1VX,KM1VX,IOIN,
     & IOUT,IOSIG,IOFLX,IO1,IO2,IO3,IO4,IO7,NER(100), IX(200),INNO(100),
     &  NGC(24),IEDG(24),ITMX(24),TIMX(6), GLIM(6),NDPL(24),IEDP1(24),
     & IEDP2(24),IEDP3(24), DPLH(6),NUAC(24),EPI(6),XMIS(6),NSRH(24),
     & XSRH1(6), XTR1(WZX),XTR2(WZX),NXTR1(WZX),NXTR2(WZX),SPARE(200),
     & IXPUT(200),XPUT(200)
C
      DIMENSION P1E(JIVX,KBVX),P2E(JIVX,KBVX,KVX),P2(JVX,IVX,KVX),
     &          SIG(KVX,MVX,12),UTIL(JVX,IVX),UTILE(JIVX,KBVX),
     &          SOURE(JVX,IVX,KBVX),XII(KVX,MVX),XI(KVX,MVX)
C
      IO26 = IX(93)
      IO18 = IX(85)
      IO28 = IX(95)
      IOFLX1 = IOFLX
      IF (NGC(13).LT.0) IOFLX1 = IO28
C
      REWIND IOFLX1
      REWIND IO26
C     INPUT FORWARD FLUX FROM NEUTRONICS
      DO 103 K=1,KMAX
      IF(NUAC(5).LE.10) GO TO 100
      READ(IOFLX1) ((P2E(N1,KB,K),N1=1,JIVX),KB=1,KBMAX)
      WRITE(IO26) ((P2E(N1,KB,K),N1=1,JIVX),KB=1,KBMAX)
      GO TO 103
  100 READ(IOFLX1) ((P2(J,I,K),J=1,JMAX),I=1,IMAX)
      N1 = 0
      DO 102 I=1,IMAX
      DO 101 J=1,JMAX
      N1 = N1 + 1
      P1E(N1,1) = P2(J,I,K)
  101 CONTINUE
  102 CONTINUE
      WRITE(IO26) (P1E(N1,1),N1=1,JIVX)
  103 CONTINUE
      IF (NGC(13).GE.0) GO TO 1104
      READ(IOFLX1) SPARE(18)
      DO 1103 M=1,MMAX
      DO 1103 K=1,KMAX
      XII(K,M) = XI(K,M)*SPARE(18)
 1103 CONTINUE
 1104 CONTINUE
      REWIND IO26
C     FORWARD FLUX BY GROUP FOR ALL POINTS ON LOGICAL 26
C
      IF(NGC(13).EQ.0) GO TO 107
C     OPTION TO OBTAIN ADJOINT FLUX FROM A PREVIOUS ADJOINT RUN
      IF (NGC(13).LT.0) GO TO 1105
      REWIND IO28
C     SKIP OVER FORWARD FLUX ON LOGICAL 28
      DO 104 K=1,KMAX
      READ(IO28)
  104 CONTINUE
      READ(IO28)
 1105 CONTINUE
C     INPUT ADJOINT FLUX FROM A PREVIOUS RUN
      DO 106 K=1,KMAX
      IF(NUAC(5).LE.10) GO TO 105
      READ(IO28) ((P2E(N1,KB,K),N1=1,JIVX),KB=1,KBMAX)
      GO TO 106
  105 READ(IO28) ((P2 (J,I,K),J=1,JMAX),I=1,IMAX)
  106 CONTINUE
      REWIND IO28
      GO TO 110
  107 READ(IOFLX)
C
C     INPUT ADJOINT FLUX FROM NEUTRONICS
      DO 109 K=1,KMAX
      IF(NUAC(5).LE.10) GO TO 108
      READ(IOFLX) ((P2E(N1,KB,K),N1=1,JIVX),KB=1,KBMAX)
      GO TO 109
  108 READ(IOFLX) ((P2(J,I,K),J=1,JMAX),I=1,IMAX)
  109 CONTINUE
  110 CONTINUE
      REWIND IOFLX
C     EDIT ADJOINT FLUX IF REQUESTED
      IF(IXPUT(32).EQ.0) GO TO 112
      IND=4
      IF(NUAC(5).GT.10) GO TO 111
      CALL POUT(P2,UTIL,IND,SOURE,IVX,JVX,KBVX,KVX)
      GO TO 112
  111 CALL KOUT(P2E,UTILE,IND,SOURE,IVX,JVX,KBVX,KVX,JIVX)
  112 CONTINUE
      IF(NUAC(5).GT.10) GO TO 116
      DO 115 K=1,KMAX
      N1 = 0
      DO 114 I=1,IMAX
      DO 113 J=1,JMAX
      N1 = N1 + 1
      P2E(N1,1,K) = P2(J,I,K)
  113 CONTINUE
  114 CONTINUE
  115 CONTINUE
  116 CONTINUE
      REWIND IO18
      DO 119 KB=1,KBMAX
      N1 = 0
      DO 118 I=1,IMAX
      DO 117 J=1,JMAX
      N1 = N1 + 1
      WRITE(IO18) (P2E(N1,KB,K),K=1,KMAX)
  117 CONTINUE
  118 CONTINUE
  119 CONTINUE
      REWIND IO18
C     ADJOINT FLUX BY POINT FOR ALL GROUPS ON LOGICAL 18
C
      IF (IDELAY.EQ.0) RETURN
      IOMC = IX(137)
      REWIND IOMC
      READ(IOMC,1000) I1
      READ(IOMC,1000) I1,I2,I3,I4,I5,I6
      DO 160 M=1,MMAX
      DO 150 K=1,KMAX
      READ(IOMC,1020) IDUM,SIG(K,M,5)
      IF (IDUM.LE.0) GO TO 170
      READ(IOMC,1030) (DUM,KK=1,KMAX)
  150 CONTINUE
  160 CONTINUE
  170 CONTINUE
      REWIND IOMC
      RETURN
 1000 FORMAT(6I3)
 1020 FORMAT(I6,42X,E12.0)
 1030 FORMAT(6E12.0)
      END
