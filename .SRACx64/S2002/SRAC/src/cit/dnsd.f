CDNSD --096***CITATION*** FLUX CALCULATION CONTROL FOR 2-D/ CF-FLUX
C
      SUBROUTINE DNSD(P1,P2,SOUR,NRGN,SCAC,SCAT,XII,DCONB,DCONR, PTSA,
     & BET,DEL,E1,IVX,JVX,KVX,LVX,IVXP1,JVXP1,IVZ,KVZ,IOVX,IOVZ, SPAR,
     & BIEMS,NCRP,NSPA,SIG,PVOL,NCOMP,MVX, AIO,IX3738,XLAMDA,XI,XL,B2,
     & IOADJ,IOFS,KGP1)
C
CDEL  INTEGER RGX , MSX , ZNEX , ZDX , WZX
CDEL  PARAMETER ( RGX=100, MSX=211, ZDX=200, ZNEX=1000, WZX=100 )
      INCLUDE  'CITPMINC'
C
      REAL*8 BET(MSX),DEL(MSX)
      REAL*8 P2,SCAT,SOUR
      REAL*8 XII
      REAL*8 CKSS
      REAL*8 XLAMDA
      REAL*8 T2
      REAL*8 SUMXI,TPTSA,XADB,XPDB,XS1DB,XS2DB, TL,XRDB,CS1S,CS2S,XLL1,
     & D8,XADX,YADX, XLL2,XLL3,XLL4,XLL5,XLL6,XLEK,B2LK,B3LK,B4LK,B5LK,
     & D1,D2,D3,D4,D5, D6,D7,YADB,YPDB,YLEK,YS1S,YS2S,YS1DB,YS2DB,YRDB,
     & SPR50,XLAST
C
      COMMON/ADUBP/SUMXI(ZNEX)
     &                  ,TPTSA,XADB,XPDB,XS1DB,XS2DB, TL,XRDB,CS1S,CS2S,
     &  XLL1,D8,XADX,YADX, XLL2,XLL3,XLL4,XLL5,XLL6,XLEK,B2LK,B3LK,B4LK,
     &  B5LK,D1,D2,D3,D4,D5, D6,D7,YADB,YPDB,YLEK,YS1S,YS2S,YS1DB,YS2DB,
     &  YRDB,SPR50,XLAST
      COMMON/ALSUB/BLSUB(30),TITL1(18),TITL2(18),IMAX,JMAX,KBMAX,KMAX,
     & LMAX,MMAX, NMAX,IMXP1,JMXP1,KBMXP1,NSETMX,NTO,MM1VX,KM1VX,IOIN,
     & IOUT,IOSIG,IOFLX,IO1,IO2,IO3,IO4,IO7,NER(100), IX(200),INNO(100),
     &  NGC(24),IEDG(24),ITMX(24),TIMX(6), GLIM(6),NDPL(24),IEDP1(24),
     & IEDP2(24),IEDP3(24), DPLH(6),NUAC(24),EPI(6),XMIS(6),NSRH(24),
     & XSRH1(6), XTR1(WZX),XTR2(WZX),NXTR1(WZX),NXTR2(WZX),SPARE(200),
     & IXPUT(200),XPUT(200)
      COMMON/AFLUX/BFLUX(30),KXMN8,NIT,NIIT,NIIIT,JXP1,KSCT1,KSCT2,
     & ISTART,IEP, VRGP1,VRGP2,VRGP3,VRG1,VRG2,VRGK1,VRGK2,XABS,PROD,
     & XELK,RMX,RMN,XKEF1,XKEF2,XKEF3,EXFC1,EXFC2,EXFC3, NI3,IEXTR,
     & IRECV,VRGABS,LO3,LO4,XLAMDB,EPI1,EPI2, BETTA,SAMXI,IX25,IX28,I,J,
     &  KB,K,ITMAX,ITIME, BAT(MSX),DAL(MSX)
C
      DIMENSION P1(JVX,IVX) ,P2(JVX,IVX,KVX),NRGN(JVX,IVX), SCAC(KVX,
     & MVX,KVX),SCAT(JVX,IVX),XII(KVX,MVX),DCONB(JVX,IVXP1, IOVX),
     & DCONR(JVXP1,IVZ,IOVZ),PTSA(JVX,IVX,IOVX), SOUR(JVX,IVX)
      DIMENSION E1(LVX,KVX)
      DIMENSION SPAR(NCRP,NSPA),BIEMS(KVX)
      DIMENSION SIG(KVX,MVX,10),PVOL(LVX),NCOMP(LVX)
      DIMENSION AIO(IX3738),XI(KVX,MVX),XL(6,KVX),B2(MVX,KVX)
C
C     INRB = 1  ORDINARY
C     INRB = 2  PERIODIC(REPEATING)
C     INRB = 3  90 DEGREE ROTATIONAL
C     INRB = 4  180 DEGREE ROTATIONAL
C
      INRB = IX(72) + 1
      IO19 = IX(86)
      IF (IX(135).EQ.1) REWIND IO19
      RMX = 1.0
      RMN = 1.0
C
      IX37 = IX(37)
  100 DO 151 KT1 = 1,KMAX
      IF (IX37.EQ.0) GO TO 103
      READ(IOADJ) AIO
      IF (IX(71).GT.0) GO TO 101
      K = KT1
      GO TO 102
  101 K = KGP1 - KT1
  102 CONTINUE
      IX(20) = 1
      GO TO 106
  103 CONTINUE
      IF (IX(24).GT.0) GO TO 104
      K = KT1
      GO TO 105
  104 K = KGP1-KT1
  105 CONTINUE
      IX(20) = K
  106 CONTINUE
      IF (IX(5).EQ.(-5)) GO TO 113
      IF (IX(24).EQ.0) GO TO 107
      IF(IX(17).GE.1) GO TO 109
  107 CONTINUE
      DO 108 L = 1,LMAX
      M = NCOMP(L)
      E1(L,K) = XLAMDA*SIG(K,M,5)*PVOL(L)
      IF (IX(24).EQ.0) GO TO 108
      IF ((IX(17).EQ.-2).AND.(IX(71).GT.0)) E1(L,K) =SIG(K,M,5)*PVOL(L)
  108 CONTINUE
  109 CONTINUE
      IF (IX(24).GT.0) GO TO 112
C
C***************************SEARCH OPTIONS******************************
      IF ((IX(5).EQ.0).OR.(IX(5).GE.2)) GO TO 111
C 110 XII(K) = XI(K)/SPARE(50)
  110 CONTINUE
      DO 1110 M=1,MMAX
 1110 XII(K,M)=XI(K,M)/SPARE(50)
      GO TO 112
C 111 XII(K) = XI(K)*XLAMDA
  111 CONTINUE
      DO 1111 M=1,MMAX
 1111 XII(K,M)=XI(K,M)*XLAMDA
  112 CONTINUE
      GO TO 114
  113 CONTINUE
      IF (IX(132).GT.0) READ(IOFS) SPAR
C     BIEMS(K) = XLAMDA*XI(K)
      BIEMS(K) = XLAMDA*XI(K,1)
  114 CONTINUE
      IF (IX(24).GT.0) GO TO 121
      KSCT1 = K-IX28
      IF (KSCT1.LE.0) KSCT1 = 1
      KSCT2 = MAX0((K-1),1)
      IF (K.GE.KXMN8) KSCT2 = KVX
C IRECV IS THE GROUP NO. WHICH CAN UPSCATTER TO GROUP 1. IT IS NOT BEING
C USED AND IS SET TO 0 IN BEGN.
      IF (K.LT.IRECV) KSCT2 = IRECV
  115 DO 118 I=1,IVX
      DO 117 J = 1,JVX
      P1(J,I) = P2(J,I,K)
      L = NRGN(J,I)
      M = NCOMP(L)
      CKSS = 0.0
      DO 116 KK = KSCT1,KSCT2
      CKSS = CKSS + SCAC(KK,M,K)*P2(J,I,KK)
  116 CONTINUE
C     SCAT(J,I) = CKSS*PVOL(L) + SOUR(J,I)*XII(K)
      SCAT(J,I) = CKSS*PVOL(L) + SOUR(J,I)*XII(K,M)
  117 CONTINUE
  118 CONTINUE
      IF (IX(5).NE.(-5)) GO TO 126
      BM = BIEMS(K)
      NP = 0
      DO 120 I=1,IVX
      DO 119 J=1,JVX
      NP = NP + 1
      SCAT(J,I) = SCAT(J,I) + BM*SPAR(NP,1)
  119 CONTINUE
  120 CONTINUE
      GO TO 126
  121 CONTINUE
      KSCT1 = K
      IF (K.GE.KXMN8) KSCT1 = KXMN8
      KSCT2 = K+IX28
      IF (KSCT2.GT.KVX) KSCT2 = KVX
      IF (K.LT.IRECV) KSCT1 = 1
      DO 124 I = 1,IVX
      DO 123 J = 1,JVX
      L = NRGN (J,I )
      M = NCOMP(L)
      P1(J,I) = P2(J,I,K)
      CKSS = SOUR(J,I)*SIG(K,M,4)
      DO 122 KK = KSCT1,KSCT2
      CKSS = CKSS+SCAC(K,M,KK)*P2 (J,I, KK)
  122 CONTINUE
      SCAT(J,I) = CKSS*PVOL(L)
  123 CONTINUE
  124 CONTINUE
  125 CONTINUE
  126 CONTINUE
      IF (IX(135).EQ.1) WRITE(IO19) P1
  127 NOINNR = NUAC(23)
      NUAC20 = NUAC(20)
  128 DO 133 INNR = 1,NOINNR
      IF (NUAC(5).EQ.10) GO TO 132
      IF (NUAC20.EQ.2) GO TO 129
      IF (IX(72).EQ.1) GO TO 131
      IF (NUAC(5).EQ.9) GO TO 130
  129 CALL FWRD( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,JVXP1,
     & IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ)
      IF (NUAC20.GT.0) GO TO 133
      CALL FXRD( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,JVXP1,
     & IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ)
      GO TO 133
  130 CALL HWRD( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,JVXP1,
     & IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ)
      IF (NUAC20.GT.0) GO TO 133
      CALL HXRD( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,JVXP1,
     & IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ)
      GO TO 133
  131 CALL DPER(SCAT,P2,DCONB,DCONR,PTSA,NRGN,E1,BET,DEL, IVX,JVX,KVX,
     & IVXP1,JVXP1,IVZ,KVZ,LVX,IOVX,IOVZ)
      GO TO 133
  132 CONTINUE
      CALL FTRI( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,JVXP1,
     & IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ)
  133 CONTINUE
  134 CONTINUE
      IF ((NUAC(3).GT.0).OR.(IX(24).GT.0)) GO TO 147
      XLL1 = 0.0
      XLL2 = 0.0
      XLL3 = 0.0
      XLL4 = 0.0
      N = IX(20)
      DO 135 M=1,MMAX
      B2(M,K) = 0.0
  135 CONTINUE
      DO 138 J = 1,JMAX
      XLL2 = XLL2+P2(J,1,K)*DCONB(J,1,N)
      T1 = DCONB(J,IMXP1,N)
      IF (NUAC(5).NE.10) GO TO 136
      IF (J.EQ.1) GO TO 138
      T1 = DCONB(J-1,IMXP1,N)
  136 CONTINUE
      IF (T1-4096.0E-13) 137,138,137
  137 XLL4 = XLL4+P2(J,IMAX,K)*T1
  138 CONTINUE
      DO 140 I = 1,IMAX
      XLL1 = XLL1+P2(1,I,K)*DCONR(1,I,N)
      T1 = DCONR(JMXP1,I,N)
      IF (T1-4096.0E-13) 139,140,139
  139 XLL3 = XLL3+P2(JMAX,I,K)*T1
  140 CONTINUE
      GO TO (141,142,143,144),INRB
  141 XLEK = XLEK + XLL1 + XLL2 + XLL3 + XLL4
      GO TO 145
  142 XLEK = XLEK + XLL2 + XLL4
      XLL1 = XLL1 - XLL3
      XLL3 = (-XLL1)
      GO TO 145
  143 XLEK = XLEK + XLL1 + XLL2
      XLL4 = (-XLL3)
      GO TO 145
  144 XLEK = XLEK + XLL1 + XLL2 + XLL4
      XLL3 = 0.0
  145 CONTINUE
      XL(1,K) = XLL1
      XL(2,K) = XLL2
      XL(3,K) = XLL3
      XL(4,K) = XLL4
      IF (NUAC(17).LE.0) GO TO 146
      CALL FINS(P2,B2,NRGN,DCONB,DCONR,SCAC,XL,IVX,JVX,KVX, LVX,IVXP1,
     & JVXP1,IVZ,IOVX,IOVZ,PVOL,NCOMP,MVX)
  146 CONTINUE
  147 CONTINUE
      DO 150 I=1,IMAX
      DO 149 J=1,JMAX
      TT1 = P1(J,I)
      T2 = P2(J,I,K)
      IF (TT1.EQ.0.0) GO TO 148
      RATO = T2/TT1
      RMX = AMAX1(RMX,RATO)
      RMN = AMIN1(RMN,RATO)
  148 CONTINUE
  149 CONTINUE
  150 CONTINUE
  151 CONTINUE
      IF (IX(135).EQ.1) REWIND IO19
      RETURN
      END
