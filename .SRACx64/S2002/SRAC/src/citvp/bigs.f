CBIGS-VP-077 ***CITATION*** CALC. ZONE MACRO. SIGS/ CF-EIGN,UDTE,KDTE
C     INDO=0 - NORMAL     INDO=1 - UPDATING IN DIRECT SEARCH
C
      SUBROUTINE BIGS(F1,CONC,SS1,SS2,SS3,SS4,SS5,SSC,SIG,HOL,ONEOV,
     & INDO,NJJR,KVX,MVX,NVX,NSETVX,BBND,XI,ZONEN,NNXTRA,NVO,
     & BVSIGF,DXII,BLSIGF)
C
C**** ARRAY F1 IS USING THE CORE RESERVED FOR ARRAY SCAC
C
CDEL  INTEGER RGX , MSX , ZNEX , ZDX , WZX
CDEL  PARAMETER ( RGX=100, MSX=211, ZDX=200, ZNEX=1000, WZX=100 )
      INCLUDE  'CITPMINC'
C
      COMMON/ALSUB/BLSUB(30),TITL1(18),TITL2(18),IMAX,JMAX,KBMAX,KMAX,
     & LMAX,MMAX, NMAX,IMXP1,JMXP1,KBMXP1,NSETMX,NTO,MM1VX,KM1VX,IOIN,
     & IOUT,IOSIG,IOFLX,IO1,IO2,IO3,IO4,IO7,NER(100), IX(200),INNO(100),
     &  NGC(24),IEDG(24),ITMX(24),TIMX(6), GLIM(6),NDPL(24),IEDP1(24),
     & IEDP2(24),IEDP3(24), DPLH(6),NUAC(24),EPI(6),XMIS(6),NSRH(24),
     & XSRH1(6), XTR1(WZX),XTR2(WZX),NXTR1(WZX),NXTR2(WZX),SPARE(200),
     & IXPUT(200),XPUT(200)
      COMMON/ABURN/BBURN(30),NSIG1(50),NSIG2(50),NSIG3(50),N1N2R(2,ZDX),
     &  NSIG4(50),NSIG5(50),NSIG6(50),NJM(50),NJMM(50),NJNQ(50),NCH(50),
     &  NZON(ZDX),NXSET(ZDX),NXODR(ZDX),IDXSET(ZDX),NCLASS(ZDX),NDP(ZDX)
     & , XNAME(3,ZDX)
C
      DIMENSION F1(KVX,KVX,MVX),CONC(NVX,MVX),SS1(KVX,NVX,NSETVX),
     & SS2(KVX,NVX,NSETVX),SS3(KVX,NVX,NSETVX), SS4(KVX,NVX,NSETVX),
     & SS5(KVX,NVX,NSETVX), SSC(KVX,KVX ),SIG(KVX,MVX,10),HOL(NVX,
     & NSETVX,10), ONEOV(KVX,NSETVX),NJJR(NVX,NSETVX),BBND(KVX)
      DIMENSION XI(KVX)
      DIMENSION ZONEN(NVO),NNXTRA(NVX,NSETVX)
      DIMENSION BVSIGF(KVX,15,MVX),DXII(KVX,15,MVX),BLSIGF(KVX,15,MVX)
C
      IO14 = IX(81)
      I = 0
      IF (INDO.EQ.1) GO TO 105
      IF (NGC(19)) 100,100,148
  100 IF (MM1VX-MVX) 103,101,103
  101 IF (KM1VX-KVX) 103,102,103
  102 I = 0
      GO TO 105
  103 IF (INNO(24)) 102,104,102
  104 I = 1
  105 DO 110 M = 1,MMAX
      DO 109 K = 1,KMAX
      SIG(K,M,1) = 0.0
      SIG(K,M,2) = 0.0
      SIG(K,M,3) = 0.0
      SIG(K,M,4) = 0.0
      SIG(K,M,5) = 0.0
      IF (I) 107,107,106
  106 SIG(K,M,6) = 0.0
  107 SIG(K,M,7) = 0.0
      SIG(K,M,8) = 0.0
      DO 108 KK = 1,KMAX
      F1(KK,K,M) = 0.0
  108 CONTINUE
  109 CONTINUE
  110 CONTINUE
      IF (IX(166).LE.1) GO TO 111
      IO12 = IX(79)
      REWIND IO12
      READ(IO12)
  111 CONTINUE
      DO 134 M=1,MMAX
      NS = NXSET(M)
      NR = NXODR(NS)
      NSX = NSIG2(NR)
      IF (IX(166).LE.1) GO TO 112
      NSUBZ = NZON(M)
      NL = NSX*NSUBZ
      READ(IO12)
      READ(IO12) (ZONEN(L),L=1,NL)
  112 CONTINUE
      DO 133 K=1,KMAX
      DO 132 N=1,NSX
      IF (IX(166).LE.0) GO TO 119
      IF (NNXTRA(N,NR).NE.10) GO TO 119
      IF (IX(166).NE.1) GO TO 115
      CN = CONC(N,M)
      IF (CN.EQ.0.0) GO TO 113
      CNS = SS5(K,N,NR)
      IF (CNS.EQ.0.0) GO TO 113
      C = CNS/CN
      IF (C.GT.200) GO TO 113
      Y = 2.0*(SQRT(C*(C+1)) - C)
      GO TO 114
  113 Y = 1.0
  114 S1 = Y*SS1(K,N,NR)
      S2 = Y*SS2(K,N,NR)
      CSS1 = CN*S1
      CSS2 = CN*S2
      GO TO 122
  115 CONTINUE
      CSS1 = 0.0
      CSS2 = 0.0
*VOCL LOOP,SCALAR
      DO 118 LZ =1,NSUBZ
      NSZ = (LZ-1)*NSX + N
      CN = ZONEN(NSZ)
      IF (CN.EQ.0.0) GO TO 116
      CNS = SS5(K,N,NR)
      IF (CNS.EQ.0.0) GO TO 116
      C = CNS/CN
      IF (C.GT.200) GO TO 116
      Y = 2.0*(SQRT(C*(C+1)) - C)
      GO TO 117
  116 Y = 1.0
  117 S1 = Y*SS1(K,N,NR)
      S2 = Y*SS2(K,N,NR)
      CSS1 = CSS1 + CN*S1
      CSS2 = CSS2 + CN*S2
  118 CONTINUE
      ZN = FLOAT(NSUBZ)
      CSS1 = CSS1/ZN
      CSS2 = CSS2/ZN
      GO TO 122
  119 CONTINUE
      IF (NNXTRA(N,NR).NE.6) GO TO 120
      CSS1 = CONC(N,M)*(SS1(K,N,NR) - 2.0*SS5(K,N,NR))
      GO TO 121
  120 CSS1 = CONC(N,M)*SS1(K,N,NR)
  121 CSS2 = CONC(N,M)*SS2(K,N,NR)
  122 CONTINUE
      DTMP = 3.0*CONC(N,M)*SS3(K,N,NR)
      IF (SIG(K,M,1)) 123,124,123
  123 DTMP = DTMP+1.0/SIG(K,M,1)
  124 IF (DTMP) 125,126,125
  125 SIG(K,M,1) = 1.0/DTMP
  126 SIG(K,M,3) = SIG(K,M,3) + CSS1
      SIG(K,M,4) = SIG(K,M,4) + CSS2*SS4(K,N,NR)
      SIG(K,M,7) = SIG(K,M,7) + CSS2*HOL(N,NR,9)
  127 IF (IX(5).NE.1) GO TO 131
      IF (IX(128).GT.0) GO TO 131
      IF ((IX(44).EQ.0).AND.(IX(49).EQ.0)) GO TO 129
      IF (IX(49).GT.0) GO TO 128
      IF ((M.EQ.IX(44)).OR.(M.EQ.IX(45)).OR.(M.EQ.IX(46))
     & .OR.(M.EQ.IX(47)).OR.(M.EQ.IX(48))) GO TO 129
      GO TO 131
  128 IF (IX(49).NE.NCLASS(M)) GO TO 131
  129 DO 130 INI = 12,18
      IF (NJJR(N,NR).NE.NSRH(INI)) GO TO 130
      SIG(K,M,5) = SIG(K,M,5) + CSS1
      SIG(K,M,8) = SIG(K,M,8) + CSS2*SS4(K,N,NR)
  130 CONTINUE
  131 CONTINUE
      IF (IX(5).EQ.-1) SIG(K,M,5) = ONEOV(K,NR)
  132 CONTINUE
  133 CONTINUE
  134 CONTINUE
      IF (IX(166).GT.1) REWIND IO12
      DO 139 NR=1,NSETMX
      NSX = NSIG2(NR)
      NKC = NSIG3(NR)
      DO 138 N=1,NSX
      READ(IO4) ((SSC(KK,K),KK=1,NKC),K=1,NKC)
      DO 137 M=1,MMAX
      NS = NXSET(M)
      NRR = NXODR(NS)
      IF (NRR.NE.NR) GO TO 137
      DO 136 K=1,KMAX
      DO 135 KK=1,KMAX
      IF (K.EQ.KK) GO TO 135
      F1(KK,K,M) = F1(KK,K,M) + SSC(KK,K)*CONC(N,M)
  135 CONTINUE
  136 CONTINUE
  137 CONTINUE
  138 CONTINUE
  139 CONTINUE
      REWIND IO4
      IF (IX(128).LE.0) GO TO 143
      IO18 = IX(85)
      REWIND IO18
      READ(IO18) NXZ
      READ(IO18) (NXTR1(I),I=1,NXZ)
      DO 142 I=1,NXZ
      M = NXTR1(I)
      NS = NXSET(M)
      NR = NXODR(NS)
      NSX = NSIG2(NR)
      READ(IO18) (XTR1(N),N=1,NSX)
      DO 141 N=1,NSX
      DO 140 K=1,KMAX
      SIG(K,M,5) = SIG(K,M,5) + XTR1(N)*SS1(K,N,NR)
      SIG(K,M,8) = SIG(K,M,8) + XTR1(N)*SS2(K,N,NR)*SS4(K,N,NR)
  140 CONTINUE
  141 CONTINUE
  142 CONTINUE
      REWIND IO18
  143 CONTINUE
  144 DO 147 M = 1,MMAX
      DO 146 K = 1,KMAX
      DO 145 KK = 1,KMAX
      SIG(K,M,2) = SIG(K,M,2)+F1(KK,K,M)
  145 CONTINUE
  146 CONTINUE
  147 CONTINUE
      IF (INDO.EQ.1) GO TO 176
  148 NGSCU = 0
      NGSCD = 0
      NSIGNL = 0
      IF (NGC(19).LE.0) GO TO 153
      IF (IX(5).EQ.(-1)) GO TO 151
      DO 150 M=1,MMAX
      DO 149 K=1,KMAX
      SIG(K,M,5) = 0.0
  149 CONTINUE
  150 CONTINUE
  151 CONTINUE
      REWIND IO14
      DO 152 K=1,KMAX
      READ(IO14) ((F1(KK,K,M),KK=1,KMAX),M=1,MMAX)
  152 CONTINUE
  153 CONTINUE
      N17 = NUAC(17)
      IF (N17.EQ.0) GO TO 159
      NOTZ = 0
      DO 158 M = 1,MMAX
      IF (N17.NE.M) GO TO 158
      NOTZ = 1
      DO 157 K = 1,KMAX
      IF (XMIS(2).GE.0) GO TO 154
      IF (BBND(K).EQ.0) GO TO 157
  154 CONTINUE
      DO 155 KK = 1,KMAX
      F1(KK,K,M) = 0.0
  155 CONTINUE
      DO 156 I = 1,8
      SIG(K,M,I) = 0.0
  156 CONTINUE
  157 CONTINUE
  158 CONTINUE
      IF (NOTZ.GT.0) GO TO 159
      WRITE(IOUT,1000)
      STOP
  159 CONTINUE
      DO 167 M = 1,MMAX
      DO 166 K = 1,KMAX
      DO 165 KK = 1,KMAX
      IF (F1(KK,K,M).EQ.0.0) GO TO 165
      T1 = ABS(SIG(K,M,2)/F1(KK,K,M))
      IF (T1.LE.1.0E+10) GO TO 160
      F1(KK,K,M) = 0.0
      GO TO 165
  160 CONTINUE
  161 KKMK = KK-K
      KXMKK = KMAX-KK
      IF (KKMK) 164,162,163
  162 NSIGNL = 1
      F1(KK,K,M) = 0.0
      GO TO 165
  163 NGSCD = MAX0(NGSCD,KKMK)
      GO TO 165
  164 NGSCU = MAX0(NGSCU,KXMKK)
  165 CONTINUE
  166 CONTINUE
  167 CONTINUE
      IDTI = 0
      IF (NSIGNL) 169,169,168
  168 WRITE(IOUT,1001)
      IDTI = 1
  169 IF (NGSCU-IX(29)) 170,171,170
  170 WRITE(IOUT,1002)IX(29),NGSCU
      IX(29) = NGSCU
      IDTI = 1
  171 IF (NGSCD-IX(28)) 172,173,172
  172 WRITE(IOUT,1003)IX(28),NGSCD
      IX(28) = NGSCD
      IDTI = 1
C*****IDTI=0 SUPRESSES SCATTERING ARRAY OUTPUT UNLESS WANTED*****
      IDTI = 0
  173 IF (IDTI) 174,174,175
  174 IF ((IX(103).EQ.0).AND.(IX(104).EQ.0)) GO TO 176
CM175 CALL XSET(SIG,F1,KVX,MVX,IDTI)
CM175 CALL XSET(SIG,F1,KVX,MVX,IDTI,BVSIGF,DXII)
  175 CALL XSET(SIG,F1,KVX,MVX,IDTI,BVSIGF,DXII,BLSIGF)
  176 CONTINUE
      IF (IX(40).GT.0) GO TO 178
      REWIND IO14
      DO 177 K=1,KMAX
      WRITE(IO14) ((F1(KK,K,M),KK=1,KMAX),M=1,MMAX)
  177 CONTINUE
      END FILE IO14
      REWIND IO14
  178 CONTINUE
      IF (NUAC(20).LT.0) GO TO 180
      IF (NUAC(5).GT.10) GO TO 179
      IF ((NUAC(20).EQ.0).AND.(NGSCU.GT.0)) NUAC(20) = 1
      GO TO 180
  179 IF ((NUAC(20).EQ.0).AND.(NGSCU.GT.0)) NUAC(20) = 0
  180 CONTINUE
      IF (NUAC(23).GT.0) GO TO 182
      IF (NUAC(5).GT.10) GO TO 181
CNN
CNN   NUAC(23) = 1
      NUAC(23) = 8
CNN
      GO TO 182
  181 NUAC(23) = 5
CNN   IF(NUAC(20).LT.0) NUAC(23) = 1
CNN   IF (NGSCU.GT.0) NUAC(23) = 1
  182 CONTINUE
      RETURN
 1000 FORMAT('0ERROR STOP 30'/' BLACK ABSORBER ZONE NUMBER (NUAC17,',
     &       'SECTION 003) IS NOT ONE OF SPECIFIED ZONES.')
 1001 FORMAT(1H0/'0**********WARNING**********',
     & '  THERE IS SCATTERING FROM SOME GROUP TO ITSELF - HAS BEEN SET',
     & '  TO ZERO')
 1002 FORMAT(1H0/1H0'**********WARNING**********'
     & ,'  INPUT SPECIFIED UPSCATTER =',I3,
     &  '  HAS BEEN CHANGED TO ACTUAL UPSCATTER =',I3)
 1003 FORMAT(1H0/1H0'**********WARNING**********',
     &  '  INPUT SPECIFIED DOWNSCATTER =',I3,
     &  '  HAS BEEN CHANGED TO ACTUAL DOWNSCATTER =',I3)
      END
