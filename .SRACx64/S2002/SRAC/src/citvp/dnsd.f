CDNSD-VP-096***CITATION*** FLUX CALCULATION CONTROL FOR 2-D/ CF-FLUX
C
      SUBROUTINE DNSD(P1,P2,SOUR,NRGN,SCAC,SCAT,XII,DCONB,DCONR, PTSA,
     & BET,DEL,E1,IVX,JVX,KVX,LVX,IVXP1,JVXP1,IVZ,KVZ,IOVX,IOVZ, SPAR,
     & BIEMS,NCRP,NSPA,SIG,PVOL,NCOMP,MVX, AIO,IX3738,XLAMDA,XI,XL,B2,
     & IOADJ,IOFS,KGP1,PY,PPY,DCONBY,DCONRY,SCATY,CKSSY,ZZY,ISWOE)
C
CDEL  INTEGER RGX , MSX , ZNEX , ZDX , WZX
CDEL  PARAMETER ( RGX=100, MSX=211, ZDX=200, ZNEX=1000, WZX=100 )
      INCLUDE  'CITPMINC'
C
      REAL*8 PY((JVX+2+ISWOE)*(IVX+2)),PPY((JVX+2+ISWOE)*(IVX+2))
      REAL*8 DCONBY((JVX+2+ISWOE)*(IVX+2))
      REAL*8 DCONRY((JVX+2+ISWOE)*(IVX+2))
      REAL*8 SCATY((JVX+2+ISWOE)*(IVX+2))
      REAL*8 CKSSY(JVX*IVX),ZZY((JVX+2+ISWOE)*(IVX+2))
C
      REAL*8 BET(MSX),DEL(MSX)
      REAL*8 P2,SCAT,SOUR
      REAL*8 XII
      REAL*8 XLAMDA
      REAL*8 SUMXI,TPTSA,XADB,XPDB,XS1DB,XS2DB, TL,XRDB,CS1S,CS2S,XLL1,
     & D8,XADX,YADX, XLL2,XLL3,XLL4,XLL5,XLL6,XLEK,B2LK,B3LK,B4LK,B5LK,
     & D1,D2,D3,D4,D5, D6,D7,YADB,YPDB,YLEK,YS1S,YS2S,YS1DB,YS2DB,YRDB,
     & SPR50,XLAST
C
      COMMON/ADUBP/SUMXI(ZNEX)
     &                  ,TPTSA,XADB,XPDB,XS1DB,XS2DB, TL,XRDB,CS1S,CS2S,
     &  XLL1,D8,XADX,YADX, XLL2,XLL3,XLL4,XLL5,XLL6,XLEK,B2LK,B3LK,B4LK,
     &  B5LK,D1,D2,D3,D4,D5, D6,D7,YADB,YPDB,YLEK,YS1S,YS2S,YS1DB,YS2DB,
     &  YRDB,SPR50,XLAST
      COMMON/ALSUB/BLSUB(30),TITL1(18),TITL2(18),IMAX,JMAX,KBMAX,KMAX,
     & LMAX,MMAX, NMAX,IMXP1,JMXP1,KBMXP1,NSETMX,NTO,MM1VX,KM1VX,IOIN,
     & IOUT,IOSIG,IOFLX,IO1,IO2,IO3,IO4,IO7,NER(100), IX(200),INNO(100),
     &  NGC(24),IEDG(24),ITMX(24),TIMX(6), GLIM(6),NDPL(24),IEDP1(24),
     & IEDP2(24),IEDP3(24), DPLH(6),NUAC(24),EPI(6),XMIS(6),NSRH(24),
     & XSRH1(6), XTR1(WZX),XTR2(WZX),NXTR1(WZX),NXTR2(WZX),SPARE(200),
     & IXPUT(200),XPUT(200)
      COMMON/AFLUX/BFLUX(30),KXMN8,NIT,NIIT,NIIIT,JXP1,KSCT1,KSCT2,
     & ISTART,IEP, VRGP1,VRGP2,VRGP3,VRG1,VRG2,VRGK1,VRGK2,XABS,PROD,
     & XELK,RMX,RMN,XKEF1,XKEF2,XKEF3,EXFC1,EXFC2,EXFC3, NI3,IEXTR,
     & IRECV,VRGABS,LO3,LO4,XLAMDB,EPI1,EPI2, BETTA,SAMXI,IX25,IX28,I,J,
     &  KB,K,ITMAX,ITIME, BAT(MSX),DAL(MSX)
C
      DIMENSION P1(JVX*IVX) ,P2(JVX*IVX,KVX),NRGN(JVX*IVX), SCAC(KVX,
     & MVX,KVX),SCAT(JVX,IVX),XII(KVX,MVX),DCONB(JVX,IVXP1, IOVX),
     & DCONR(JVXP1,IVZ,IOVZ),PTSA(JVX,IVX,IOVX), SOUR(JVX*IVX)
      DIMENSION E1(LVX,KVX)
      DIMENSION SPAR(NCRP,NSPA),BIEMS(KVX)
      DIMENSION SIG(KVX,MVX,10),PVOL(LVX),NCOMP(LVX)
      DIMENSION AIO(IX3738),XI(KVX,MVX),XL(6,KVX),B2(MVX,KVX)
C
CMOD  DATA LFIRST/0/
      COMMON   /CITKXY/ KXY,LFIRST
C
      IF( LFIRST.EQ.0 ) THEN
      JP2=JVX+2+ISWOE
      JIYY=JP2*(IVX+2)
      JIVX=JVX*IVX
C
      DO 200 JI=1,JIYY
        PY(JI)=0.0D0
        ZZY(JI)=1.0D0
        SCATY(JI)=0.0D0
  200 CONTINUE
C
      DO 204 I=1,IVXP1
      DO 204 J=1,JVX
  204   DCONBY(JP2*I+J+1)=0.0D0
C
      DO 206 I=1,IVX
      DO 206 J=1,JVXP1
  206   DCONRY(JP2*I+J+1)=0.0D0
C
      LFIRST=1
      ENDIF
C
C     INRB = 1  ORDINARY
C     INRB = 2  PERIODIC(REPEATING)
C     INRB = 3  90 DEGREE ROTATIONAL
C     INRB = 4  180 DEGREE ROTATIONAL
C
      INRB = IX(72) + 1
      IO19 = IX(86)
      IF (IX(135).EQ.1) REWIND IO19
      RMX = 1.0
      RMN = 1.0
      IX37 = IX(37)
C
      DO 151 KT1 = 1,KVX
      IF(IX37.EQ.0) THEN
        IF(IX(24).GT.0) THEN
          K=KGP1-KT1
          ELSE
          K=KT1
        ENDIF
        IX(20)=K
      ELSE
C
        READ(IOADJ) AIO
C
        IF(IX(71).GT.0) THEN
          K=KGP1-KT1
          ELSE
          K=KT1
        ENDIF
        IX(20)=1
      ENDIF
C
      IF (IX(5).EQ.(-5)) GO TO 113
      IF (IX(24).EQ.0) GO TO 107
      IF(IX(17).GE.1) GO TO 109
  107 CONTINUE
      IF(IX(24).NE.0.AND.(IX(17).EQ.-2).AND.(IX(71).GT.0)) THEN
      DO 220 L = 1,LVX
  220   E1(L,K)=SIG(K,NCOMP(L),5)*PVOL(L)
      ELSE
      DO 222 L = 1,LVX
  222   E1(L,K)=XLAMDA*SIG(K,NCOMP(L),5)*PVOL(L)
      ENDIF
  109 CONTINUE
      IF (IX(24).GT.0) GO TO 114
C
C***************************SEARCH OPTIONS******************************
      DO 1110 M=1,MMAX
      IF((IX(5).EQ.0).OR.(IX(5).GE.2)) THEN
        XII(K,M)=XI(K,M)*XLAMDA
        ELSE
        XII(K,M)=XI(K,M)/SPARE(50)
      ENDIF
 1110 CONTINUE
      GO TO 114
  113 CONTINUE
      IF (IX(132).GT.0) READ(IOFS) SPAR
      BIEMS(K) = XLAMDA*XI(K,1)
  114 CONTINUE
      IF (IX(24).GT.0) GO TO 121
      KSCT1 = K-IX28
      IF (KSCT1.LE.0) KSCT1 = 1
      KSCT2 = MAX0((K-1),1)
      IF (K.GE.KXMN8) KSCT2 = KVX
C IRECV IS THE GROUP NO. WHICH CAN UPSCATTER TO GROUP 1. IT IS NOT BEING
C USED AND IS SET TO 0 IN BEGN.
      IF (K.LT.IRECV) KSCT2 = IRECV
      DO 230 JI=1,JIVX
        P1(JI)=P2(JI,K)
  230   CKSSY(JI)=0.0D0
      DO 234 KK=KSCT1,KSCT2
      DO 232 JI=1,JIVX
  232   CKSSY(JI)=CKSSY(JI)+SCAC(KK,NCOMP(NRGN(JI)),K)*P2(JI,KK)
  234 CONTINUE
      DO 236 I=1,IVX
      DO 236 J=1,JVX
        M = NCOMP( NRGN( JVX*( I - 1 ) + J ) )
        SCATY(JP2*I+J+1)=CKSSY(JVX*(I-1)+J)*PVOL(NRGN(JVX*(I-1)+J))
     &    +SOUR(JVX*(I-1)+J)*XII(K,M)
  236 CONTINUE
C
      IF (IX(5).NE.(-5)) GO TO 126
      BM = BIEMS(K)
      DO 238 I=1,IVX
      DO 238 J=1,JVX
      SCATY(JP2*I+J+1)=SCATY(JP2*I+J+1)+BM*SPAR((I-1)*JVX+J,1)
  238 CONTINUE
      GO TO 126
  121 CONTINUE
      KSCT1 = K
      IF (K.GE.KXMN8) KSCT1 = KXMN8
      KSCT2 = K+IX28
      IF (KSCT2.GT.KVX) KSCT2 = KVX
      IF (K.LT.IRECV) KSCT1 = 1
      DO 240 JI=1,JIVX
        P1(JI)=P2(JI,K)
  240   CKSSY(JI)=SOUR(JI)*SIG(K,NCOMP(NRGN(JI)),4)
      DO 244 KK=KSCT1,KSCT2
      DO 242 JI=1,JIVX
  242   CKSSY(JI)=CKSSY(JI)+SCAC(K,NCOMP(NRGN(JI)),KK)*P2(JI,KK)
  244 CONTINUE
      DO 246 I=1,IVX
      DO 246 J=1,JVX
        SCATY(JP2*I+J+1)=CKSSY((JVX*(I-1)+J))
     &    *PVOL(NRGN(JVX*(I-1)+J))
  246 CONTINUE
C
  126 CONTINUE
C
CBUG FOR SCALOR ROUTINE
      IF (IX(135).EQ.1) WRITE(IO19) P1
  127 NOINNR = NUAC(23)
      NUAC20 = NUAC(20)
      IF (NUAC(5).EQ.10) GO TO 402
      IF (NUAC20.EQ.2) GO TO 402
      IF (IX(72).EQ.1) GO TO 403
      IF (NUAC(5).EQ.9) GO TO 403
C VECTOR ROUTINE
  402 CONTINUE
CBUG END
      DO 400 I=1,IVXP1
      DO 400 J=1,JVX
  400   DCONBY(JP2*I+J+1)=DCONB(J,I,IX(20))
C
      DO 401 I=1,IVX
      DO 401 J=1,JVXP1
  401   DCONRY(JP2*I+J+1)=DCONR(J,I,IX(20))
C
CBUG
CBUG
      DO 250 I=1,IVX
      DO 250 J=1,JVX
  250   PY(JP2*I+J+1)=P2(JVX*(I-1)+J,K)
      DO 252 I=1,IVX
      DO 252 J=1,JVX
  252   ZZY(JP2*I+J+1)=E1(NRGN((I-1)*JVX+J),K)+PTSA(J,I,IX(20))
C
CBUG FOR SCALOR ROUTINE
      GO TO 404
C     IF(NUAC(5).EQ.9 .OR.
C    &  (NUAC(5).NE.10.AND.NUAC20.NE.2.AND.IX(72).NE.1)) THEN
  403 CONTINUE
CBUG
        DO 254 I=1,IVX
        DO 254 J=1,JVX
          SCAT(J,I)=SCATY(JP2*I+J+1)
  254   CONTINUE
C     ENDIF
  404 CONTINUE
C
      DO 133 INNR = 1,NOINNR
      IF (NUAC(5).EQ.10) GO TO 132
      IF (NUAC20.EQ.2) GO TO 129
      IF (IX(72).EQ.1) GO TO 131
      IF (NUAC(5).EQ.9) GO TO 130
  129 CONTINUE
      CALL FWRD( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,JVXP1,
     & IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ,PY,PPY,DCONBY,DCONRY,
     & SCATY,ZZY,ISWOE)
      GO TO 133
  130 CALL HWRD( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,JVXP1,
     & IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ)
CBUG FIX FOR SCALOR ROUTINE
C     IF (NUAC20.GT.0) GO TO 133
      IF (NUAC20.GT.0) GO TO 261
CBUG
      CALL HXRD( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,JVXP1,
     & IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ)
CBUG FIX FOR SCALOR ROUTINE
C     GO TO 133
      GO TO 261
CBUG
  131 CALL DPER(SCAT,P2,DCONB,DCONR,PTSA,NRGN,E1,BET,DEL, IVX,JVX,KVX,
     & IVXP1,JVXP1,IVZ,KVZ,LVX,IOVX,IOVZ)
CBUG FIX FOR SCALOR ROUTINE
C     GO TO 133
      GO TO 261
CBUG
  132 CONTINUE
      CALL FTRI( SCAT, P2,DCONB,DCONR,PTSA, IVX,JVX,KVX, IVXP1,JVXP1,
     & IVZ,KVZ,BET,DEL,NRGN,E1,LVX, IOVX,IOVZ,PY,PPY,DCONBY,DCONRY,
     & SCATY,ZZY,ISWOE)
  133 CONTINUE
C
        DO 260 I=1,IVX
        DO 260 J=1,JVX
  260     P2(JVX*(I-1)+J,K)=PY(JP2*I+J+1)
CBUG FIX FOR SCALOR ROUTINE
  261 CONTINUE
CBUG
C
      IF ((NUAC(3).GT.0).OR.(IX(24).GT.0)) GO TO 147
      XLL1 = 0.0
      XLL2 = 0.0
      XLL3 = 0.0
      XLL4 = 0.0
      N = IX(20)
      DO 135 M=1,MVX
  135   B2(M,K) = 0.0
      XLL2 = XLL2+P2(1,K)*DCONB(1,1,N)
      T1 = DCONB(1,IVXP1,N)
      IF(NUAC(5).NE.10) THEN
        IF(T1.NE.4096.0E-13) XLL4=XLL4+P2(JVX*(IVX-1)+1,K)*T1
      ENDIF
      DO 270 J=2,JVX
        XLL2=XLL2+P2(J,K)*DCONB(J,1,N)
        IF(NUAC(5).NE.10) THEN
          T1=DCONB(J,IVXP1,N)
          ELSE
          T1=DCONB(J-1,IVXP1,N)
        ENDIF
        IF(T1.NE.4096.0E-13) XLL4=XLL4+P2(JVX*(IVX-1)+J,K)*T1
  270 CONTINUE
      DO 140 I=1,IVX
        XLL1=XLL1+P2(JVX*(I-1)+1,K)*DCONR(1,I,N)
        T1=DCONR(JVXP1,I,N)
        IF(T1.NE.4096.0E-13) XLL3=XLL3+P2(JVX*(I-1)+JVX,K)*T1
  140 CONTINUE
      GO TO (141,142,143,144),INRB
  141 XLEK = XLEK + XLL1 + XLL2 + XLL3 + XLL4
      GO TO 145
  142 XLEK = XLEK + XLL2 + XLL4
      XLL1 = XLL1 - XLL3
      XLL3 = (-XLL1)
      GO TO 145
  143 XLEK = XLEK + XLL1 + XLL2
      XLL4 = (-XLL3)
      GO TO 145
  144 XLEK = XLEK + XLL1 + XLL2 + XLL4
      XLL3 = 0.0
  145 CONTINUE
      XL(1,K) = XLL1
      XL(2,K) = XLL2
      XL(3,K) = XLL3
      XL(4,K) = XLL4
      IF (NUAC(17).LE.0) GO TO 146
      CALL FINS(P2,B2,NRGN,DCONB,DCONR,SCAC,XL,IVX,JVX,KVX, LVX,IVXP1,
     & JVXP1,IVZ,IOVX,IOVZ,PVOL,NCOMP,MVX)
  146 CONTINUE
  147 CONTINUE
      DO 149 JI=1,JIVX
        IF (P1(JI).EQ.0.0) GO TO 149
        RATO = P2(JI,K)/P1(JI)
        RMX = AMAX1(RMX,RATO)
        RMN = AMIN1(RMN,RATO)
  149 CONTINUE
C
  151 CONTINUE
C
      IF (IX(135).EQ.1) REWIND IO19
      RETURN
      END
