C             GENFLO              LEVEL=1        DATE=81.11.14
      SUBROUTINE GENFLO ( H1,H2,H3,H4,V1,V2,V3,V4,YH,A3,A4,WM,WE,FD,FU,
     &FR,FL,IDX,IDYA,ITP,IT,MM,IM,IP,JM,JP,LV1,LV3 )
C
C     CALCULATES FLOWS FOR MATERIAL MESH
C
      COMMON /TW1C/ DD(1),LIM1,IA(210)
      COMMON /WORK/AAA(1),LIM2,AA(130)
      DIMENSION D(212),A(132)
      EQUIVALENCE (D(1),DD(1)),(AAA(1),A(1))
      EQUIVALENCE (D(110),IPFL),(D(124),I2),(D(111),LTFL),(D(132),LTHAF)
     &,(D(133),LTVAF),(D(158),NAFLUX)
C
      DIMENSION H1(ITP,MM),H2(ITP,MM),H3(ITP,MM),H4(ITP,MM),V1(IT,MM),
     &V2(IT,MM),V3(IT,MM),V4(IT,MM),YH(1),A3(1),A4(1),WM(1),WE(1),
     &FD(IM,JP),FU(IM,JP),FR(IP,JM),FL(IP,JM),IDX(1),IDYA(1)
C
      EQUIVALENCE (IA(4),IGM),(IA(65),JT),(IA(78),JTP)
C
      CALL REED (NAFLUX,0,0.0,0,4)
      LTFL=2*(IP*JM+IM*JP)
      DO 150 IG=1,IGM
      CALL CLEARW(0.0,FU,LTFL)
C
C     COMPUTE VERTICAL FLOWS
C
      DO 120 J=1,JTP
      J1=IDYA(J)
      J2=IDYA(J-1)
      IF (J.EQ.JTP) J1=JP
      IF (J1.EQ.J2) GO TO 110
CKSK  CALL REED (NAFLUX,0,A(LV1),LTVAF,2)
CKSK  CALL REED (NAFLUX,0,A(LV3),LTVAF,2)
      CALL REED (NAFLUX,0,AAA(LV1),LTVAF,2)
      CALL REED (NAFLUX,0,AAA(LV3),LTVAF,2)
      DO 100 I=1,IT
      I1=IDX(I)
      DO 100 M=1,MM
      FD(I1,J1)=FD(I1,J1)+WE(M)*A3(I)*(V1(I,M)+V2(I,M))
  100 FU(I1,J1)=FU(I1,J1)+WE(M)*A3(I)*(V3(I,M)+V4(I,M))
      GO TO 120
  110 CALL REED (NAFLUX,0,0.0,1,7)
      CALL REED (NAFLUX,0,0.0,1,7)
  120 CONTINUE
C
C     COMPUTE HORIZONTAL FLOWS
C
      DO 140 J=1,JT
      J1=IDYA(J)
CKSK  CALL REED (NAFLUX,0,A(LV1),LTHAF,2)
CKSK  CALL REED (NAFLUX,0,A(LV3),LTHAF,2)
      CALL REED (NAFLUX,0,AAA(LV1),LTHAF,2)
      CALL REED (NAFLUX,0,AAA(LV3),LTHAF,2)
      DO 140 I=1,ITP
      I1=IDX(I)
      I2=IDX(I-1)
      IF (I.EQ.ITP) I1=IP
      IF (I1.EQ.I2) GO TO 140
      T=A4(I)*YH(J)
      DO 130 M=1,MM
      FL(I1,J1)=FL(I1,J1)+WM(M)*T*(H1(I,M)+H3(I,M))
  130 FR(I1,J1)=FR(I1,J1)+WM(M)*T*(H2(I,M)+H4(I,M))
  140 CONTINUE
C
C     STORE FLOWS IN LCM
C
      CALL RITE (0,IPFL+(IG-1)*LTFL,FU,LTFL,1)
  150 CONTINUE
      RETURN
      END
