C**********************************************************************
C                           FORM
C**********************************************************************
      SUBROUTINE FORM(CG,P,N,SIG,NPRL,NPRBL,ID,G,IDIM,IDIM1,NGMAX,
     1                MATMAX,MAT,VOL)
      COMMON / PIJ2C / IGT,NZ,NR,NRR,NXR,IBOND,IDRECT,ICOUNT,IPRPIJ,
     1                 IFORM,NTTAB,NUTAB,SZ,ITYPE,ID15(20),IOPT
      COMMON / MAINC / DDM(63),NOUT1,NOUT2,IT0,DUM67(34),CASENM(2)
C
      DIMENSION P(IDIM,*),G(*),SIG(NGMAX,*),MAT(*),VOL(*)
      CHARACTER *4  COMT(2,2),CASENM
      EQUIVALENCE (DDM(40),IFIXS)
      DATA COMT/'ISOT','ROPC','  RA','DIAL'/
C
C === BLACK BOUNDARY IF SURFACE SOURCE IS SPECIFIED
C
      IFIX=0
      IF(IOPT.EQ.1 .AND. IFIXS.EQ.2) IFIX=1
      IBOUND=IBOND
      IF(IFIX.EQ.1) IBOUND=2
C === FROM SYMMETRIC DELTA TO MODIFIED PROB.
C === PSTAR(I,J) =(DELTA(I,J)+DELTA(J,I))/2./VOL(I)
C
      DO 550 I=1,IDIM
      P(I,I)=P(I,I)/VOL(I)
      IP1=I+1
      IF(IP1.GT.IDIM)GO TO 540
      DO 530 J=IP1,IDIM
      TEMP= (P(I,J)+P(J,I))/2.
      P(I,J)=TEMP/VOL(I)
      P(J,I)=TEMP/VOL(J)
  530 CONTINUE
  540 P(I,IDIM1)=P(I,IDIM1)/VOL(I)
  550 CONTINUE
C     P(I,IDIM1) : PROB BORN IN REGION I TO ESCAPE FROM SURFACE
C                  EXCEPT THE CASE IBOUND=1
C     NORMALIZATION
C
      DO 580 I=1,IDIM
      SUM1=0.
      DO 560 K=1,IDIM
      M=MAT(K)
  560 SUM1=SUM1+SIG(N,M)*P(I,K)
      SUM1=SUM1+P(I,IDIM1)
      DO 570 J=1,IDIM1
      P(I,J)=P(I,J)/SUM1
  570 CONTINUE
  580 CONTINUE
C
C    ISOTROPIC REFLECTION          FOR IBOUND=0 ISOTROPIC
C    CORRECTION TO TRIMMING ERROR  FOR IBOUND=1 REFLECTIVE
C    SURFACE TO VOLUME PROBABILITY FOR IBOUND=2 BLACK
C
      SUM1=0.
      DO 680 I=1,IDIM
      M=MAT(I)
      GO TO (610,620,630),IBOUND+1
  610 G(I)=P(I,IDIM1)*4.*VOL(I)/SZ/CG
C     G(I) : PROB. FROM SURFACE TO REGION I DIVIDED BY SIG(I)
      GO TO 640
  620 G(I)=VOL(I)
      GO TO 640
  630 G(I)=P(I,IDIM1)*4./SZ/CG
C     G(I) : PROB. FROM SURFACE TO REGION I DIVIDED BY SIG(I)*VOL(I)
C     WHICH YIELDS SOURCE DENSITY INDUCED BY SURFACE CURRENT
      GO TO 680
  640 SUM1=SUM1+G(I)*SIG(N,M)
  680 CONTINUE
C
      IF(IBOUND .EQ.2) GO TO 750
C     P(I,IDIM1) IN CASE OF PERIODIC CONDITION KEEPS TRUNCATED PROB.
C     CAUSED BY RELIMITED OPTICAL DISTANCE TO EVALUATE P(I,J)
C     WHICH WILL BE REDISTRIBUTED BY SIG*VOL AS WEIGHT
      DO 690 I=1,IDIM
      DO 690 J=1,IDIM
      P(I,J)=P(I,J)+P(I,IDIM1)*G(J)/SUM1
  690 CONTINUE
C
C     G  FOR PARTIAL DIFFUSION COEFFICIENT IN BENOIST MODEL
C
  700 DO 740 I=1,IDIM
      G(I)=0.
      DO 740 J=1,IDIM
CM    G(I)=G(I)+P(I,J)/3.
      G(I)=G(I)+P(I,J)*0.333333333333
  740 CONTINUE
C
C === MODIFIED PROBABILITY TO ORDINARY PROBABILITY
C
  750 IF(IFORM.EQ.1) GO TO 770
      DO 760 I=1,IDIM
      M=MAT(I)
      SI=SIG(N,M)
      DO 755 J=1,IDIM
      P(J,I)=P(J,I)*SI
  755 CONTINUE
  760 CONTINUE
C
C === PRINT OUT
C
CK770 CALL CLOCK(IT)
  770 CALL UCLOCK(IT)
      IT=IT-IT0
C     IF(IPRPIJ.EQ.0 .AND. IGT.GE.8) WRITE(NOUT1,3006) N,IT
      IF(IPRPIJ.EQ.0) GO TO 800
C     PRINT 3007
      DO 790 I=1,IDIM
      IF(NPRL+NPRBL.LT. 59) GO TO 780
      WRITE(NOUT2,3000) CASENM,IT
      WRITE(NOUT2,3001) COMT(1,ID),COMT(2,ID)
      NPRL=2
  780 WRITE(NOUT2,3002) N,I,(P(I,J),J=1,IDIM1)
      NPRL=NPRL+NPRBL
  790 CONTINUE
      WRITE(NOUT2,3004)   (G(I),I=1,IDIM)
      NPRL=NPRL+NPRBL
C
C === STORE PROBABILITIES
C                P(I,J) DENOTES PROB. FROM I TO J
  800 GO TO (810,820),ID
  810 WRITE(21) ((P(I,J),I=1,IDIM),J=1,IDIM)
  820 WRITE(22) (G(I),I=1,IDIM)
C === G(I) ELEMENT OF DIFFUSION COEF. OR SURFACE TO VOLUME PROB.
      RETURN
CKSK
*3000 FORMAT(1H1,10X,27H** COLLISION PROBABILITY **  2A4/
*    1     30X            17H ** ELAPSED TIME   I6,4H SEC)
*3001 FORMAT(1H0,2A4,10H DIRECTION )
*3002 FORMAT(1H0,2HG=I3,3H I=I3 ,10F12.6/(12X,10F12.6))
*3004 FORMAT(1H0 6X,5HDIFF ,10F12.6/(12X,10F12.6))
*3006 FORMAT(1H ,10X,3H G= I3,17H ** ELAPSED TIME   I6,4H SEC)
*3007 FORMAT(1H )
 3000 FORMAT(1H1,10X,27H** COLLISION PROBABILITY ** ,2A4/
     1     30X,           17H ** ELAPSED TIME  ,I6,4H SEC)
 3001 FORMAT(1H0,2A4,10H DIRECTION )
 3002 FORMAT(1H0,2HG=,I3,3H I=,I3 ,10F12.6/(12X,10F12.6))
 3004 FORMAT(1H0,6X,5HDIFF ,10F12.6/(12X,10F12.6))
 3006 FORMAT(1H ,10X,3H G=,I3,17H ** ELAPSED TIME  ,I6,4H SEC)
 3007 FORMAT(1H )
CKSK
      END
