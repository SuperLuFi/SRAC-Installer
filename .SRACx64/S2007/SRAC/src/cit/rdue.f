CRDUE --103 ***CITATION*** RESIDUE CALC. FOR 1,2-D/ CF-FLUX
C
      SUBROUTINE RDUE(SCAC, RESLM,RESSA, P2 ,NRGN , SOUR ,DCONR ,DCONB ,
     &  XI, IVX,JVX,KVX,LVX,IVXP1,JVXP1,IVZ,KVZ, IOVX,IOVZ,A,MEMORY,AIO,
     &  IX3738,XLAMDA, SIG,PVOL,NCOMP,MVX)
C
CDEL  INTEGER RGX , MSX , ZNEX , ZDX , WZX
CDEL  PARAMETER ( RGX=100, MSX=211, ZDX=200, ZNEX=1000, WZX=100 )
      INCLUDE  'CITPMINC'
C
      REAL*8 P2,P2UT,P2UB,P2UL,P2UR,P2UH,P2UI,T1,TT1,TT2,TT3,TT4,TT5,
     & TT6,XLA,SOUR
      REAL*8 XLAMDA
      REAL*8 XLD
      REAL *8 TTT1, TTT2, TTT3, TTT4
C
      COMMON/ALSUB/BLSUB(30),TITL1(18),TITL2(18),IMAX,JMAX,KBMAX,KMAX,
     & LMAX,MMAX, NMAX,IMXP1,JMXP1,KBMXP1,NSETMX,NTO,MM1VX,KM1VX,IOIN,
     & IOUT,IOSIG,IOFLX,IO1,IO2,IO3,IO4,IO7,NER(100), IX(200),INNO(100),
     &  NGC(24),IEDG(24),ITMX(24),TIMX(6), GLIM(6),NDPL(24),IEDP1(24),
     & IEDP2(24),IEDP3(24), DPLH(6),NUAC(24),EPI(6),XMIS(6),NSRH(24),
     & XSRH1(6), XTR1(WZX),XTR2(WZX),NXTR1(WZX),NXTR2(WZX),SPARE(200),
     & IXPUT(200),XPUT(200)
      COMMON/AFLUX/BFLUX(30),KXMN8,NIT,NIIT,NIIIT,JXP1,KSCT1,KSCT2,
     & ISTART,IEP, VRGP1,VRGP2,VRGP3,VRG1,VRG2,VRGK1,VRGK2,XABS,PROD,
     & XLEK,RMX,RMN,XKEF1,XKEF2,XKEF3,EXFC1,EXFC2,EXFC3, NI3,IEXTR,
     & IRECV,VRGABS,LO3,LO4,XLAMDB,EPI1,EPI2, BETTA,SUMXI,IX25,IX28,I,J,
     &  KB,K,ITMAX,ITIME, BET(MSX),DEL(MSX)
C
      DIMENSION SCAC(KVX,MVX,KVX), P2 (JVX,IVX, KVX),NRGN (JVX, IVX ),
     & SOUR (JVX,IVX ), DCONR (JVXP1,IVZ,IOVZ),DCONB (JVX,IVXP1, IOVX),
     & XI(KVX,MVX)
      DIMENSION AIO(IX3738)
      DIMENSION A(MEMORY)
      DIMENSION SIG(KVX,MVX,10),PVOL(LVX),NCOMP(LVX)
C
C     INRB = 1  ORDINARY
C     INRB = 2  PERIODIC(REPEATING)
C     INRB = 3  90 DEGREE ROTATIONAL
C     INRB = 4  180 DEGREE ROTATIONAL
C
      INRB = IX(72) + 1
      KMAXP1 = KMAX + 1
      IX37 = IX(37)
      IX38 = IX(38)
      IO15 = IX(82)
      IOADJ = IO15
      IF (IX(71).GT.0) IOADJ = IO2
      IF (IX37.GT.0) REWIND IOADJ
      TTT1 = 0.0
      TTT2 = 0.0
      TTT3 = 0.0
      TTT4 = 0.0
      IF ((IX(24).EQ.0).OR.(IX(17).EQ.0)) GO TO 100
      XLA = 1.0/SPARE(50)
      XLD = XLAMDA
      IF (IX(17).GE.1) XLD = 0.0
      GO TO 103
  100 CONTINUE
C******************************SEARCH OPTIONS***************************
      IF ((IX(5).EQ.0).OR.(IX(5).GE.2)) GO TO 102
  101 XLD = XLAMDA
      IF (IX(5).EQ.1) XLD = 0.0
      XLA = 1.0/SPARE(50)
      GO TO 103
  102 XLD = 0.0
      XLA = XLAMDA
  103 CONTINUE
C     CONTINUE
      DO 129 KT1=1,KMAX
      IF (IX37.EQ.0) GO TO 106
      READ(IOADJ) AIO
      IF (IX(71).GT.0) GO TO 104
      K = KT1
      GO TO 105
  104 K = KMAXP1 - KT1
  105 N = 1
      GO TO 109
  106 CONTINUE
      IF (IX(24).GT.0) GO TO 107
      K = KT1
      GO TO 108
  107 K = KMAXP1 - KT1
  108 N = K
  109 CONTINUE
  110 DO 128 I = 1,IMAX
      DO 127 J = 1,JMAX
      T1 = P2 (J,I, K)
      IF (T1.EQ.0.) GO TO 127
      L = NRGN (J,I )
      M = NCOMP(L)
      TT5 = 0.0
      IF (IX(24).EQ.0) GO TO 112
      DO 111 KK = 1,KMAX
      TT5 = TT5 + SCAC(K,M,KK)*P2(J,I,KK)
  111 CONTINUE
      GO TO 114
  112 CONTINUE
      DO 113 KK = 1,KMAX
      TT5 = TT5 + SCAC(KK,M,K)*P2(J,I,KK)
  113 CONTINUE
  114 CONTINUE
      TT1 = (SIG(K,M,3) + SIG(K,M,9) + XLD*SIG(K,M,5))*T1*PVOL(L)
      TT3 = SIG(K,M,2)*T1
      TDR = DCONR (J+1,I, N)
      IF (TDR.EQ.4096.0E-13) TDR=0.0
      T2 = DCONB(J,I,N)
      T3 = DCONB(J,I+1,N)
      N2 = J
      N3 = J
      IF (NUAC(5).NE.10) GO TO 116
      NOE = J-(J/2)*2
      IF (NOE.EQ.0) GO TO 115
      N2 = N2+1
      T3 = 0.0
      GO TO 116
  115 CONTINUE
      T2 = 0.0
      N3 = N3-1
      T3 = DCONB(N3,I+1,N)
  116 CONTINUE
      P2UT = P2(N2,I-1,K)
      P2UB = P2(N3,I+1,K)
      P2UL = P2(J-1,I,K)
      P2UR = P2(J+1,I,K)
      IF (I.EQ.1) P2UT=0.
      IF (I.LT.IMAX) GO TO 117
      P2UB = 0.0
      IF (INRB.NE.3) GO TO 117
      P2UB = P2(JVX,J,K)
      IF (NUAC(5).EQ.10) P2UB = P2(JVX,J/2,K)
  117 IF (J.GT.1) GO TO 118
      P2UL = 0.0
      IF (INRB.EQ.2) P2UL = P2(JMAX,I,K)
  118 IF (J.LT.JMAX) GO TO 122
      P2UR = 0.0
      GO TO (122,119,120,121),INRB
  119 P2UR = P2(1,I,K)
      GO TO 122
  120 P2UR = P2(I,IVX,K)
      IF (NUAC(5).EQ.10) P2UR = P2(2*I,IVX,K)
      GO TO 122
  121 P2UR = P2(JVX,IVXP1-I,K)
  122 CONTINUE
      IF (NUAC(5).EQ.9) GO TO 123
      TT4 = (T1-P2UT )*T2 + (T1-P2UB )*T3 + (T1- P2UL )*DCONR (J,I, N)+
     & (T1-P2UR )*TDR
      GO TO 124
C     2-D HEXAGONAL RESIDUES CONTRIBUTION FROM LEAKAGE TERMS
  123 KKK = N+IOVX
      P2UH=P2(J-1,I+1,K)
      P2UI=P2(J+1,I-1,K)
      IF (I.EQ.1.OR.J.EQ.JMAX) P2UI=0.0
      IF (J.EQ.1.OR.I.EQ.IMAX) P2UH=0.0
      TT4 = (T1-P2UT )*DCONB (J,I, N)+ (T1-P2UB )*DCONB (J,I+1, N)+ (T1-
     &  P2UL )*DCONR (J,I, N)+ (T1-P2UR )*TDR + (T1-P2UH)*DCONR(J,I+1,
     & KKK)+ (T1-P2UI)*DCONR(J+1,I,KKK)
  124 CONTINUE
      IF (IX(24).EQ.0) GO TO 125
      TT6 = SIG(K,M,4)*PVOL(L)*SOUR(J,I)*XKEF1
      GO TO 126
C 125 TT6 = XI(K)*SOUR(J,I) + XLD*SIG(K,M,8)*PVOL(L)
  125 TT6 = XI(K,M)*SOUR(J,I) + XLD*SIG(K,M,8)*PVOL(L)
  126 CONTINUE
      TT3=PVOL(L)*(TT3-TT5)
      TTT1 = TTT1 + TT6*(TT4+TT1+TT3)
      TTT2 = TTT2 +TT6**2
      TTT3 = TTT3 + TT1*(XLA*TT6-TT4-TT3)
      TTT4 = TTT4 + TT1**2
  127 CONTINUE
  128 CONTINUE
  129 CONTINUE
      IF (IX37.GT.0) REWIND IOADJ
C     RESIDUES ESTIMATE OF EIGENVALUE (1/K)
      RESLM = TTT2/TTT1
C     RESIDUES ESTIMATE OF RELATIVE ABSORPTION CROSS SECTION
      RESSA = TTT3/TTT4
      IF (NUAC(3).LE.0.) GO TO 130
      XKEF2 = XKEF1
      XKEF1 = RESLM
      XLAMDA = 1.0/XKEF1
      VRGK1 = ABS(XKEF2/XKEF1-1.0)
  130 CONTINUE
      RETURN
      END
